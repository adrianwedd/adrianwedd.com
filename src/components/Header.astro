---
import ThemeToggle from './ThemeToggle.astro';

const navLinks = [
  { href: '/projects/', label: 'Projects' },
  { href: '/blog/', label: 'Blog' },
  { href: '/gallery/', label: 'Gallery' },
  { href: '/audio/', label: 'Audio' },
  { href: '/about/', label: 'About' },
  { href: '/contact/', label: 'Contact' },
  { href: '/search/', label: 'Search' },
];

const currentPath = Astro.url.pathname;
---

<header class="bg-surface/90 sticky top-0 z-50 border-b border-border backdrop-blur-sm">
  <nav
    class="mx-auto flex h-16 max-w-6xl items-center justify-between px-4 sm:px-6 lg:px-8"
    aria-label="Main navigation"
  >
    <a href="/" class="text-lg font-semibold text-text no-underline transition-colors hover:text-accent">
      Adrian Wedd
    </a>

    {/* Desktop nav */}
    <div class="hidden items-center gap-1 md:flex">
      {
        navLinks.map(({ href, label }) => (
          <a
            href={href}
            class:list={[
              'rounded-lg px-3 py-2 text-sm no-underline transition-colors',
              currentPath.startsWith(href)
                ? 'bg-surface-alt font-medium text-accent'
                : 'text-text-muted hover:bg-surface-alt hover:text-text',
            ]}
            aria-current={currentPath.startsWith(href) ? 'page' : undefined}
          >
            {label}
          </a>
        ))
      }
      <ThemeToggle />
    </div>

    {/* Mobile: theme toggle + hamburger */}
    <div class="flex items-center gap-2 md:hidden">
      <ThemeToggle />
      <button
        type="button"
        class="mobile-menu-btn rounded-lg p-2 text-text-muted transition-colors hover:bg-surface-alt hover:text-text"
        aria-expanded="false"
        aria-label="Open menu"
      >
        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <path class="menu-icon-open" stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"
          ></path>
          <path class="menu-icon-close hidden" stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"
          ></path>
        </svg>
      </button>
    </div>
  </nav>

  {/* Mobile menu */}
  <div
    class="mobile-menu hidden border-t border-border bg-surface md:hidden"
    role="navigation"
    aria-label="Mobile navigation"
  >
    <div class="space-y-1 px-4 py-3">
      {
        navLinks.map(({ href, label }) => (
          <a
            href={href}
            class:list={[
              'block rounded-lg px-3 py-2 text-sm no-underline transition-colors',
              currentPath.startsWith(href)
                ? 'bg-surface-alt font-medium text-accent'
                : 'text-text-muted hover:bg-surface-alt hover:text-text',
            ]}
            aria-current={currentPath.startsWith(href) ? 'page' : undefined}
          >
            {label}
          </a>
        ))
      }
    </div>
  </div>
</header>

<script>
  const btn = document.querySelector('.mobile-menu-btn')!;
  const menu = document.querySelector('.mobile-menu')!;
  const iconOpen = document.querySelector('.menu-icon-open')!;
  const iconClose = document.querySelector('.menu-icon-close')!;

  btn.addEventListener('click', () => {
    const expanded = btn.getAttribute('aria-expanded') === 'true';
    btn.setAttribute('aria-expanded', String(!expanded));
    btn.setAttribute('aria-label', expanded ? 'Open menu' : 'Close menu');
    menu.classList.toggle('hidden');
    iconOpen.classList.toggle('hidden');
    iconClose.classList.toggle('hidden');
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !menu.classList.contains('hidden')) {
      (btn as HTMLElement).click();
      (btn as HTMLElement).focus();
      return;
    }

    // Focus trap when mobile menu is open
    if (e.key === 'Tab' && !menu.classList.contains('hidden')) {
      const focusable = menu.querySelectorAll<HTMLElement>('a[href], button');
      if (focusable.length === 0) return;
      const first = focusable[0];
      const last = focusable[focusable.length - 1];

      if (e.shiftKey && document.activeElement === first) {
        e.preventDefault();
        last.focus();
      } else if (!e.shiftKey && document.activeElement === last) {
        e.preventDefault();
        first.focus();
      }
    }
  });

  // Auto-close mobile menu when a link is clicked
  menu.querySelectorAll('a[href]').forEach((link) => {
    link.addEventListener('click', () => {
      if (!menu.classList.contains('hidden')) {
        (btn as HTMLElement).click();
      }
    });
  });

  const header = document.querySelector('header')!;
  const onScroll = () => header.classList.toggle('header-scrolled', window.scrollY > 10);
  window.addEventListener('scroll', onScroll, { passive: true });
  onScroll();
</script>
