---
// GDPR-compliant consent banner.
// No tracking before consent. Respects Do Not Track.
// Granular: analytics and personalisation toggles.
---

<div
  id="consent-banner"
  class="fixed bottom-0 inset-x-0 z-[100] hidden"
  role="dialog"
  aria-label="Cookie consent"
  aria-describedby="consent-description"
>
  <div class="max-w-3xl mx-auto p-4 sm:p-6">
    <div class="rounded-xl bg-surface-raised border border-border shadow-raised p-6">
      <p id="consent-description" class="text-sm text-text leading-relaxed">
        This site uses cookies for analytics and personalisation.
        No tracking happens without your consent. You can change your preferences at any time.
      </p>

      <div class="mt-4 space-y-3">
        <label class="flex items-center gap-3 text-sm cursor-pointer">
          <input type="checkbox" id="consent-analytics" class="accent-accent w-4 h-4" />
          <span class="text-text">Analytics</span>
          <span class="text-text-muted"> — helps me understand which content is useful</span>
        </label>
        <label class="flex items-center gap-3 text-sm cursor-pointer">
          <input type="checkbox" id="consent-personalisation" class="accent-accent w-4 h-4" />
          <span class="text-text">Personalisation</span>
          <span class="text-text-muted"> — remembers your preferences for a better experience</span>
        </label>
      </div>

      <div class="mt-5 flex flex-wrap gap-3">
        <button
          id="consent-accept-all"
          type="button"
          class="px-4 py-2 rounded-lg bg-accent text-surface text-sm font-medium hover:bg-accent-hover transition-colors"
        >
          Accept all
        </button>
        <button
          id="consent-accept-selected"
          type="button"
          class="px-4 py-2 rounded-lg border border-border text-text text-sm hover:border-accent hover:text-accent transition-colors"
        >
          Accept selected
        </button>
        <button
          id="consent-reject"
          type="button"
          class="px-4 py-2 rounded-lg text-text-muted text-sm hover:text-text transition-colors"
        >
          Reject all
        </button>
      </div>

      <p class="mt-3 text-xs text-text-muted">
        <a href="/about/#privacy" class="hover:text-accent transition-colors">Privacy details</a>
      </p>
    </div>
  </div>
</div>

<script>
  type ConsentState = {
    analytics: boolean;
    personalisation: boolean;
    timestamp: number;
  };

  const CONSENT_KEY = 'adrianwedd_consent';

  function getConsent(): ConsentState | null {
    try {
      const raw = localStorage.getItem(CONSENT_KEY);
      if (!raw) return null;
      return JSON.parse(raw);
    } catch {
      return null;
    }
  }

  function setConsent(state: ConsentState) {
    localStorage.setItem(CONSENT_KEY, JSON.stringify(state));
    // Also set a cookie for server-side awareness
    document.cookie = `consent=${state.analytics ? 'a' : ''}${state.personalisation ? 'p' : ''}; path=/; max-age=31536000; SameSite=Lax`;
    // Dispatch event for other components
    window.dispatchEvent(new CustomEvent('consent-updated', { detail: state }));
  }

  function isDNT(): boolean {
    return navigator.doNotTrack === '1' || (window as any).doNotTrack === '1';
  }

  function showBanner() {
    document.getElementById('consent-banner')!.classList.remove('hidden');
  }

  function hideBanner() {
    document.getElementById('consent-banner')!.classList.add('hidden');
  }

  function save(analytics: boolean, personalisation: boolean) {
    setConsent({ analytics, personalisation, timestamp: Date.now() });
    hideBanner();
  }

  // Check if we already have consent
  const existing = getConsent();
  if (!existing) {
    // If DNT is set, don't show banner — just record rejection
    if (isDNT()) {
      save(false, false);
    } else {
      showBanner();
    }
  }

  // Wire up buttons
  document.getElementById('consent-accept-all')!.addEventListener('click', () => {
    save(true, true);
  });

  document.getElementById('consent-accept-selected')!.addEventListener('click', () => {
    const analytics = (document.getElementById('consent-analytics') as HTMLInputElement).checked;
    const personalisation = (document.getElementById('consent-personalisation') as HTMLInputElement).checked;
    save(analytics, personalisation);
  });

  document.getElementById('consent-reject')!.addEventListener('click', () => {
    save(false, false);
  });
</script>
