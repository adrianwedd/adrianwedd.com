---
// Minimal consent banner — single line, unobtrusive.
// No tracking before consent. Respects Do Not Track.
// "Manage" expands granular options inline.
---

<div id="consent-banner" class="fixed inset-x-0 bottom-0 z-[100] hidden" role="dialog" aria-label="Cookie consent" aria-live="polite">
  <div class="bg-surface/95 border-t border-border shadow-card backdrop-blur-sm">
    <!-- Compact bar -->
    <div id="consent-compact" class="mx-auto flex max-w-6xl items-center justify-between gap-4 px-4 py-3">
      <p class="text-xs text-text-muted">
        This site uses cookies for analytics (aggregate traffic data) and personalisation (visit count, stored locally).
        No tracking before consent. <a href="/about/#privacy" class="underline transition-colors hover:text-accent"
          >Full privacy details</a
        >
      </p>
      <div class="flex shrink-0 items-center gap-2">
        <button id="consent-manage" type="button" class="text-xs text-text-muted transition-colors hover:text-text">
          Manage
        </button>
        <button id="consent-reject" type="button" class="text-xs text-text-muted transition-colors hover:text-text">
          Decline
        </button>
        <button
          id="consent-accept-all"
          type="button"
          class="rounded-md bg-accent px-3 py-1 text-xs font-medium text-surface transition-colors hover:bg-accent-hover"
        >
          OK
        </button>
      </div>
    </div>

    <!-- Expanded options (hidden by default) -->
    <div id="consent-expanded" class="mx-auto hidden max-w-6xl px-4 pb-3">
      <p class="mb-3 max-w-2xl text-xs text-text-muted">
        <strong class="text-text">Analytics:</strong> Google Analytics 4 tracks aggregate traffic—what gets read, where readers
        come from. No individual session reconstruction.
        <strong class="ml-3 text-text">Personalisation:</strong> Visit counter stored in your browser's localStorage. Never
        leaves your device.
      </p>
      <div class="flex flex-wrap items-center gap-4 text-xs">
        <label class="flex cursor-pointer items-center gap-2">
          <input type="checkbox" id="consent-analytics" class="h-3.5 w-3.5 accent-accent" />
          <span class="text-text-muted">Analytics</span>
        </label>
        <label class="flex cursor-pointer items-center gap-2">
          <input type="checkbox" id="consent-personalisation" class="h-3.5 w-3.5 accent-accent" />
          <span class="text-text-muted">Personalisation</span>
        </label>
        <button
          id="consent-accept-selected"
          type="button"
          class="rounded-md border border-border px-3 py-1 text-xs text-text-muted transition-colors hover:border-accent hover:text-accent"
        >
          Save
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  type ConsentState = {
    analytics: boolean;
    personalisation: boolean;
    timestamp: number;
  };

  const CONSENT_KEY = 'adrianwedd_consent';

  function getConsent(): ConsentState | null {
    try {
      const raw = localStorage.getItem(CONSENT_KEY);
      if (!raw) return null;
      return JSON.parse(raw);
    } catch {
      return null;
    }
  }

  function setConsent(state: ConsentState) {
    localStorage.setItem(CONSENT_KEY, JSON.stringify(state));
    document.cookie = `consent=${state.analytics ? 'a' : ''}${state.personalisation ? 'p' : ''}; path=/; max-age=31536000; SameSite=Lax`;
    window.dispatchEvent(new CustomEvent('consent-updated', { detail: state }));
  }

  function isDNT(): boolean {
    return navigator.doNotTrack === '1' || (window as any).doNotTrack === '1';
  }

  function showBanner() {
    document.getElementById('consent-banner')!.classList.remove('hidden');
  }

  function hideBanner() {
    document.getElementById('consent-banner')!.classList.add('hidden');
  }

  function save(analytics: boolean, personalisation: boolean) {
    setConsent({ analytics, personalisation, timestamp: Date.now() });
    hideBanner();
  }

  // Check if we already have consent
  const existing = getConsent();
  if (!existing) {
    if (isDNT()) {
      save(false, false);
    } else {
      showBanner();
    }
  }

  // Wire up buttons
  document.getElementById('consent-accept-all')!.addEventListener('click', () => {
    save(true, true);
  });

  document.getElementById('consent-reject')!.addEventListener('click', () => {
    save(false, false);
  });

  document.getElementById('consent-manage')!.addEventListener('click', () => {
    document.getElementById('consent-expanded')!.classList.toggle('hidden');
  });

  document.getElementById('consent-accept-selected')!.addEventListener('click', () => {
    const analytics = (document.getElementById('consent-analytics') as HTMLInputElement).checked;
    const personalisation = (document.getElementById('consent-personalisation') as HTMLInputElement).checked;
    save(analytics, personalisation);
  });
</script>
