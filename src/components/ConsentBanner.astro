---
// Minimal consent banner — single line, unobtrusive.
// No tracking before consent. Respects Do Not Track.
// "Manage" expands granular options inline.
---

<div
  id="consent-banner"
  class="fixed bottom-0 inset-x-0 z-[100] hidden"
  role="dialog"
  aria-label="Cookie consent"
>
  <div class="border-t border-border bg-surface/95 backdrop-blur-sm shadow-card">
    <!-- Compact bar -->
    <div id="consent-compact" class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between gap-4">
      <p class="text-xs text-text-muted">
        This site uses cookies for analytics (aggregate traffic data) and personalisation (visit count, stored locally).
        No tracking before consent. <a href="/about/#privacy" class="hover:text-accent transition-colors underline">Full privacy details</a>
      </p>
      <div class="flex items-center gap-2 shrink-0">
        <button id="consent-manage" type="button" class="text-xs text-text-muted hover:text-text transition-colors">
          Manage
        </button>
        <button id="consent-reject" type="button" class="text-xs text-text-muted hover:text-text transition-colors">
          Decline
        </button>
        <button id="consent-accept-all" type="button" class="px-3 py-1 rounded-md bg-accent text-surface text-xs font-medium hover:bg-accent-hover transition-colors">
          OK
        </button>
      </div>
    </div>

    <!-- Expanded options (hidden by default) -->
    <div id="consent-expanded" class="hidden max-w-6xl mx-auto px-4 pb-3">
      <p class="text-xs text-text-muted mb-3 max-w-2xl">
        <strong class="text-text">Analytics:</strong> Google Analytics 4 tracks aggregate traffic—what gets read, where readers come from. No individual session reconstruction.
        <strong class="text-text ml-3">Personalisation:</strong> Visit counter stored in your browser's localStorage. Never leaves your device.
      </p>
      <div class="flex flex-wrap items-center gap-4 text-xs">
        <label class="flex items-center gap-2 cursor-pointer">
          <input type="checkbox" id="consent-analytics" class="accent-accent w-3.5 h-3.5" />
          <span class="text-text-muted">Analytics</span>
        </label>
        <label class="flex items-center gap-2 cursor-pointer">
          <input type="checkbox" id="consent-personalisation" class="accent-accent w-3.5 h-3.5" />
          <span class="text-text-muted">Personalisation</span>
        </label>
        <button id="consent-accept-selected" type="button" class="px-3 py-1 rounded-md border border-border text-text-muted text-xs hover:border-accent hover:text-accent transition-colors">
          Save
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  type ConsentState = {
    analytics: boolean;
    personalisation: boolean;
    timestamp: number;
  };

  const CONSENT_KEY = 'adrianwedd_consent';

  function getConsent(): ConsentState | null {
    try {
      const raw = localStorage.getItem(CONSENT_KEY);
      if (!raw) return null;
      return JSON.parse(raw);
    } catch {
      return null;
    }
  }

  function setConsent(state: ConsentState) {
    localStorage.setItem(CONSENT_KEY, JSON.stringify(state));
    document.cookie = `consent=${state.analytics ? 'a' : ''}${state.personalisation ? 'p' : ''}; path=/; max-age=31536000; SameSite=Lax`;
    window.dispatchEvent(new CustomEvent('consent-updated', { detail: state }));
  }

  function isDNT(): boolean {
    return navigator.doNotTrack === '1' || (window as any).doNotTrack === '1';
  }

  function showBanner() {
    document.getElementById('consent-banner')!.classList.remove('hidden');
  }

  function hideBanner() {
    document.getElementById('consent-banner')!.classList.add('hidden');
  }

  function save(analytics: boolean, personalisation: boolean) {
    setConsent({ analytics, personalisation, timestamp: Date.now() });
    hideBanner();
  }

  // Check if we already have consent
  const existing = getConsent();
  if (!existing) {
    if (isDNT()) {
      save(false, false);
    } else {
      showBanner();
    }
  }

  // Wire up buttons
  document.getElementById('consent-accept-all')!.addEventListener('click', () => {
    save(true, true);
  });

  document.getElementById('consent-reject')!.addEventListener('click', () => {
    save(false, false);
  });

  document.getElementById('consent-manage')!.addEventListener('click', () => {
    document.getElementById('consent-expanded')!.classList.toggle('hidden');
  });

  document.getElementById('consent-accept-selected')!.addEventListener('click', () => {
    const analytics = (document.getElementById('consent-analytics') as HTMLInputElement).checked;
    const personalisation = (document.getElementById('consent-personalisation') as HTMLInputElement).checked;
    save(analytics, personalisation);
  });
</script>
