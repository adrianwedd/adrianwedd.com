---
import { getCollection } from 'astro:content';
import { slug } from '../lib/utils';

interface Props {
  currentTags: string[];
  currentId: string;
  contentType: 'blog' | 'projects' | 'gallery' | 'audio';
  limit?: number;
}

const { currentTags, currentId, contentType, limit = 3 } = Astro.props;

// Gather all content types
const [blogs, projects, galleries, audios] = await Promise.all([
  getCollection('blog'),
  getCollection('projects'),
  getCollection('gallery').catch(() => []),
  getCollection('audio').catch(() => []),
]);

type ContentItem = {
  id: string;
  type: 'blog' | 'projects' | 'gallery' | 'audio';
  title: string;
  description: string;
  tags: string[];
  href: string;
  score: number;
};

const allItems: ContentItem[] = [
  ...blogs.filter(p => !p.data.draft).map(p => ({
    id: `blog:${p.id}`,
    type: 'blog' as const,
    title: p.data.title,
    description: p.data.description,
    tags: p.data.tags,
    href: `/blog/${slug(p.id)}/`,
    score: 0,
  })),
  ...projects.map(p => ({
    id: `projects:${p.id}`,
    type: 'projects' as const,
    title: p.data.title,
    description: p.data.description,
    tags: p.data.tags,
    href: p.data.url || `/projects/${slug(p.id)}/`,
    score: 0,
  })),
  ...galleries.map(p => ({
    id: `gallery:${p.id}`,
    type: 'gallery' as const,
    title: p.data.title,
    description: p.data.description || '',
    tags: p.data.tags,
    href: `/gallery/${slug(p.id)}/`,
    score: 0,
  })),
  ...audios.map(p => ({
    id: `audio:${p.id}`,
    type: 'audio' as const,
    title: p.data.title,
    description: p.data.description,
    tags: p.data.tags,
    href: `/audio/${slug(p.id)}/`,
    score: 0,
  })),
];

// Score by tag overlap, excluding current item
const related = allItems
  .filter(item => item.id !== `${contentType}:${currentId}`)
  .map(item => ({
    ...item,
    score: item.tags.filter(t => currentTags.includes(t)).length,
  }))
  .filter(item => item.score > 0)
  .sort((a, b) => b.score - a.score || (a.type === contentType ? 1 : -1))
  .slice(0, limit);

const typeLabels: Record<string, string> = {
  blog: 'Post',
  projects: 'Project',
  gallery: 'Gallery',
  audio: 'Audio',
};
---

{related.length > 0 && (
  <aside class="mt-12 pt-8 border-t border-border" aria-label="Related content">
    <h3 class="text-sm font-semibold text-text-muted uppercase tracking-wider mb-4">Related</h3>
    <div class="space-y-3">
      {related.map(item => (
        <a href={item.href} class="group flex items-start gap-3 no-underline">
          <span class="text-xs px-2 py-0.5 rounded-full bg-surface-alt border border-border text-text-muted whitespace-nowrap mt-0.5">
            {typeLabels[item.type]}
          </span>
          <span class="text-sm text-text group-hover:text-accent transition-colors">
            {item.title}
          </span>
        </a>
      ))}
    </div>
  </aside>
)}
