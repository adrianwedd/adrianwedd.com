---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { slug } from '../../lib/utils';

const episodes = (await getCollection('audio')).sort((a, b) => b.data.date.getTime() - a.data.date.getTime());
const allTags = [...new Set(episodes.flatMap((e) => e.data.tags))].sort();
---

<BaseLayout
  title="Audio"
  description="Conversations with AI tools about failure modes, risk frameworks, and ideas too raw for text. The workshop extended—thinking aloud."
>
  <section class="mx-auto max-w-4xl px-4 py-16 sm:px-6 lg:px-8">
    <div class="mb-4 flex items-baseline justify-between">
      <h1 class="text-text">Audio</h1>
      <a href="/audio/feed.xml" class="text-sm text-text-muted transition-colors hover:text-accent">
        Podcast RSS &nearr;
      </a>
    </div>
    <p class="max-w-prose text-text-muted">
      Conversations with AI tools about failure modes, risk frameworks, and ideas too raw for text. The workshop
      extended—thinking aloud.
    </p>

    {
      allTags.length > 0 && (
        <nav class="mt-8 flex flex-wrap gap-2" id="tag-filters" aria-label="Filter by tag">
          <button
            type="button"
            data-tag=""
            class="tag-filter bg-accent/10 cursor-pointer rounded-full border border-accent px-3 py-1 text-xs font-medium text-accent transition-colors"
            aria-pressed="true"
          >
            All
          </button>
          {allTags.map((tag, i) => (
            <button
              type="button"
              data-tag={tag}
              class:list={[
                'tag-filter cursor-pointer rounded-full border border-border px-3 py-1 text-xs text-text-muted transition-colors hover:border-accent hover:text-accent',
                i >= 10 && 'audio-tag-overflow hidden',
              ]}
              aria-pressed="false"
            >
              {tag}
            </button>
          ))}
          {allTags.length > 10 && (
            <button
              type="button"
              id="audio-tags-toggle"
              class="cursor-pointer rounded-full border border-border px-3 py-1 text-xs text-text-muted transition-colors hover:border-accent hover:text-accent"
            >
              +{allTags.length - 10} more
            </button>
          )}
        </nav>
      )
    }

    {/* Sort control */}
    <div class="mt-4 flex items-center gap-2">
      <label for="sort-select" class="text-xs text-text-muted">Sort:</label>
      <select
        id="sort-select"
        class="rounded border border-border bg-surface-alt px-2 py-1 text-xs text-text-muted focus:border-accent focus:outline-none"
      >
        <option value="newest">Newest first</option>
        <option value="oldest">Oldest first</option>
        <option value="alpha">A–Z</option>
      </select>
    </div>

    <div class="mt-6 space-y-6" id="audio-list">
      {
        episodes.map((episode) => (
          <article
            class="audio-card transition-opacity duration-200"
            data-tags={JSON.stringify(episode.data.tags)}
            data-date={episode.data.date.toISOString()}
            data-title={episode.data.title}
          >
            <a
              href={`/audio/${slug(episode.id)}/`}
              class="card-hover hover:border-accent/50 group block rounded-xl border border-border bg-surface-alt p-6 no-underline shadow-subtle transition-all hover:shadow-card"
            >
              <div class="flex items-start justify-between gap-4">
                <div>
                  <h2 class="text-lg font-semibold text-text transition-colors group-hover:text-accent">
                    {episode.data.title}
                  </h2>
                  <p class="mt-1 text-sm leading-relaxed text-text-muted">{episode.data.description}</p>
                  <div class="mt-2 flex items-center gap-3 text-xs text-text-muted">
                    {episode.data.duration && <span>{episode.data.duration}</span>}
                    <div class="flex gap-2">
                      {episode.data.tags.map((tag: string) => (
                        <span class="rounded-full border border-border bg-surface px-2 py-0.5">{tag}</span>
                      ))}
                    </div>
                  </div>
                </div>
                <time class="whitespace-nowrap text-xs text-text-muted" datetime={episode.data.date.toISOString()}>
                  {episode.data.date.toLocaleDateString('en-AU', { day: 'numeric', month: 'short', year: 'numeric' })}
                </time>
              </div>
            </a>
          </article>
        ))
      }
    </div>

    <p id="no-results" class="mt-10 hidden text-center text-text-muted">No episodes match this filter.</p>
  </section>

  <script>
    const list = document.getElementById('audio-list')!;
    const cards = Array.from(document.querySelectorAll<HTMLElement>('.audio-card'));
    const tagFilters = document.getElementById('tag-filters');
    const sortSelect = document.getElementById('sort-select') as HTMLSelectElement;
    const noResults = document.getElementById('no-results')!;

    let activeTag = '';

    function applyFilters() {
      let visible = 0;
      cards.forEach((card) => {
        const match = !activeTag || (JSON.parse(card.dataset.tags || '[]') as string[]).includes(activeTag);
        card.style.opacity = match ? '1' : '0';
        setTimeout(() => { card.style.display = match ? '' : 'none'; }, match ? 0 : 200);
        if (match) visible++;
      });
      noResults.classList.toggle('hidden', visible > 0);
    }

    function applySort() {
      const sorted = [...cards].sort((a, b) => {
        const sort = sortSelect.value;
        if (sort === 'newest') return new Date(b.dataset.date!).getTime() - new Date(a.dataset.date!).getTime();
        if (sort === 'oldest') return new Date(a.dataset.date!).getTime() - new Date(b.dataset.date!).getTime();
        return (a.dataset.title || '').localeCompare(b.dataset.title || '');
      });
      sorted.forEach((card) => list.appendChild(card));
    }

    function setActiveButton(value: string) {
      tagFilters?.querySelectorAll('.tag-filter').forEach((b) => {
        const el = b as HTMLElement;
        const match = (el.dataset.tag || '') === value;
        el.classList.toggle('border-accent', match);
        el.classList.toggle('bg-accent/10', match);
        el.classList.toggle('text-accent', match);
        el.classList.toggle('font-medium', match);
        el.classList.toggle('border-border', !match);
        el.classList.toggle('text-text-muted', !match);
        el.setAttribute('aria-pressed', match ? 'true' : 'false');
      });
    }

    // Tag overflow toggle
    const tagToggle = document.getElementById('audio-tags-toggle');
    if (tagToggle) {
      let expanded = false;
      tagToggle.dataset.label = tagToggle.textContent || '';
      tagToggle.addEventListener('click', () => {
        expanded = !expanded;
        document.querySelectorAll('.audio-tag-overflow').forEach((el) => {
          (el as HTMLElement).classList.toggle('hidden', !expanded);
        });
        tagToggle.textContent = expanded ? 'Show less' : tagToggle.dataset.label || '';
      });
    }

    tagFilters?.addEventListener('click', (e) => {
      const btn = (e.target as HTMLElement).closest<HTMLButtonElement>('.tag-filter');
      if (!btn) return;
      activeTag = btn.dataset.tag || '';
      setActiveButton(activeTag);
      applyFilters();
    });

    sortSelect.addEventListener('change', () => {
      applySort();
      applyFilters();
    });
  </script>
</BaseLayout>
