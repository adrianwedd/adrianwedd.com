---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Breadcrumb from '../../components/Breadcrumb.astro';
import ShareButton from '../../components/islands/ShareButton';
import RelatedContent from '../../components/RelatedContent.astro';
import AudioPlayer from '../../components/islands/AudioPlayer';
import { getCollection, render } from 'astro:content';
import { slug } from '../../lib/utils';

export async function getStaticPaths() {
  const episodes = await getCollection('audio');
  return episodes.map((episode) => ({
    params: { slug: slug(episode.id) },
    props: { episode },
  }));
}

const { episode } = Astro.props;
const { Content } = await render(episode);
---

<BaseLayout
  title={episode.data.title}
  description={episode.data.description}
  image={episode.data.heroImage}
  type="article"
  publishedDate={episode.data.date.toISOString()}
  tags={episode.data.tags}
>
  <article class="mx-auto max-w-3xl px-4 py-16 sm:px-6 lg:px-8">
    <Breadcrumb
      crumbs={[{ label: 'Home', href: '/' }, { label: 'Audio', href: '/audio/' }, { label: episode.data.title }]}
    />
    <header class="mb-8">
      <div class="mb-4 flex items-center gap-3 text-sm text-text-muted">
        <time datetime={episode.data.date.toISOString()}>
          {episode.data.date.toLocaleDateString('en-AU', { day: 'numeric', month: 'long', year: 'numeric' })}
        </time>
        {
          episode.data.duration && (
            <>
              <span aria-hidden="true">&middot;</span>
              <span>{episode.data.duration}</span>
            </>
          )
        }
      </div>
      <div class="flex items-start justify-between gap-4">
        <h1 class="text-text">{episode.data.title}</h1>
        <span class="mt-2 shrink-0">
          <ShareButton title={episode.data.title} url={`/audio/${slug(episode.id)}/`} client:idle />
        </span>
      </div>
      <p class="mt-4 text-lg leading-relaxed text-text-muted">{episode.data.description}</p>

      {
        (episode.data.relatedProject || episode.data.relatedPost) && (
          <div class="mt-6 rounded-lg border border-border bg-surface-alt p-4">
            <p class="text-sm text-text-muted">
              {episode.data.relatedProject && (
                <>
                  Generated for project:{' '}
                  <a href={`/projects/${episode.data.relatedProject}/`} class="font-medium text-accent hover:underline">
                    {episode.data.relatedProject
                      .split('-')
                      .map((w) => w.charAt(0).toUpperCase() + w.slice(1))
                      .join(' ')}
                  </a>
                </>
              )}
              {episode.data.relatedPost && (
                <>
                  Companion to article:{' '}
                  <a href={`/blog/${episode.data.relatedPost}/`} class="font-medium text-accent hover:underline">
                    {episode.data.relatedPost
                      .split('-')
                      .map((w) => w.charAt(0).toUpperCase() + w.slice(1))
                      .join(' ')}
                  </a>
                </>
              )}
            </p>
          </div>
        )
      }
    </header>

    <div class="mb-10">
      <AudioPlayer client:load src={episode.data.audioUrl} title={episode.data.title} />
    </div>

    <div
      class="prose prose-invert max-w-none prose-headings:font-semibold prose-headings:text-text prose-p:leading-relaxed prose-p:text-text prose-a:text-accent"
    >
      <Content />
    </div>

    {
      episode.data.transcript && (
        <details class="mt-10 rounded-lg border border-border">
          <summary class="cursor-pointer px-4 py-3 text-sm font-medium text-text transition-colors hover:text-accent">
            Transcript
          </summary>
          <div class="whitespace-pre-wrap px-4 pb-4 text-sm leading-relaxed text-text-muted">
            {episode.data.transcript}
          </div>
        </details>
      )
    }

    <RelatedContent currentTags={episode.data.tags} currentId={episode.id} currentDate={episode.data.date} contentType="audio" />

    <nav class="mt-16 border-t border-border pt-8" aria-label="Back to audio">
      <a href="/audio/" class="text-sm text-text-muted transition-colors hover:text-accent"> &larr; All episodes </a>
    </nav>
  </article>
</BaseLayout>
