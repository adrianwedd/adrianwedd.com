---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Breadcrumb from '../../components/Breadcrumb.astro';
import ShareButton from '../../components/islands/ShareButton';
import RelatedContent from '../../components/RelatedContent.astro';
import NotebookAssets from '../../components/NotebookAssets.astro';
import AudioPlayer from '../../components/islands/AudioPlayer';
import { getCollection, render } from 'astro:content';
import { slug } from '../../lib/utils';

export async function getStaticPaths() {
  const episodes = await getCollection('audio');
  return episodes.map((episode) => ({
    params: { slug: slug(episode.id) },
    props: { episode },
  }));
}

const { episode } = Astro.props;
const { Content } = await render(episode);

const allEpisodes = (await getCollection('audio'))
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime());
const currentIndex = allEpisodes.findIndex((e) => e.id === episode.id);
const prevEpisode = currentIndex < allEpisodes.length - 1 ? allEpisodes[currentIndex + 1] : null;
const nextEpisode = currentIndex > 0 ? allEpisodes[currentIndex - 1] : null;
---

<BaseLayout
  title={episode.data.title}
  description={episode.data.description}
  image={episode.data.heroImage}
  type="article"
  publishedDate={episode.data.date.toISOString()}
  tags={episode.data.tags}
>
  <script
    type="application/ld+json"
    set:html={JSON.stringify({
      '@context': 'https://schema.org',
      '@type': 'PodcastEpisode',
      name: episode.data.title,
      description: episode.data.description,
      url: new URL(Astro.url.pathname, Astro.site).href,
      datePublished: episode.data.date.toISOString(),
      ...(episode.data.duration ? { duration: `PT${episode.data.duration.replace(':', 'M').replace(/(\d+)$/, '$1S')}` } : {}),
      associatedMedia: {
        '@type': 'AudioObject',
        contentUrl: new URL(episode.data.audioUrl, Astro.site).href,
        encodingFormat: 'audio/mpeg',
      },
      keywords: episode.data.tags,
      author: {
        '@type': 'Person',
        name: 'Adrian Wedd',
        url: 'https://adrianwedd.com',
      },
    })}
  />
  <article class="mx-auto max-w-3xl px-4 py-16 sm:px-6 lg:px-8">
    <Breadcrumb
      crumbs={[{ label: 'Home', href: '/' }, { label: 'Audio', href: '/audio/' }, { label: episode.data.title }]}
    />
    <header class="mb-8">
      <div class="mb-4 flex items-center gap-3 text-sm text-text-muted">
        <time datetime={episode.data.date.toISOString()}>
          {episode.data.date.toLocaleDateString('en-AU', { day: 'numeric', month: 'long', year: 'numeric' })}
        </time>
        {
          episode.data.duration && (
            <>
              <span aria-hidden="true">&middot;</span>
              <span>{episode.data.duration}</span>
            </>
          )
        }
      </div>
      <div class="flex items-start justify-between gap-4">
        <h1 class="text-text">{episode.data.title}</h1>
        <span class="mt-2 shrink-0">
          <ShareButton title={episode.data.title} url={`/audio/${slug(episode.id)}/`} client:idle />
        </span>
      </div>
      <p class="mt-4 text-lg leading-relaxed text-text-muted">{episode.data.description}</p>

      {
        (episode.data.relatedProject || episode.data.relatedPost) && (
          <div class="mt-6 rounded-lg border border-border bg-surface-alt p-4">
            <p class="text-sm text-text-muted">
              {episode.data.relatedProject && (
                <>
                  Generated for project:{' '}
                  <a href={`/projects/${episode.data.relatedProject}/`} class="font-medium text-accent hover:underline">
                    {episode.data.relatedProject
                      .split('-')
                      .map((w) => w.charAt(0).toUpperCase() + w.slice(1))
                      .join(' ')}
                  </a>
                </>
              )}
              {episode.data.relatedPost && (
                <>
                  Companion to article:{' '}
                  <a href={`/blog/${episode.data.relatedPost}/`} class="font-medium text-accent hover:underline">
                    {episode.data.relatedPost
                      .split('-')
                      .map((w) => w.charAt(0).toUpperCase() + w.slice(1))
                      .join(' ')}
                  </a>
                </>
              )}
            </p>
          </div>
        )
      }
    </header>

    <div class="mb-10">
      <AudioPlayer client:load src={episode.data.audioUrl} title={episode.data.title} />
    </div>

    <div
      class="prose prose-invert max-w-none prose-headings:font-semibold prose-headings:text-text prose-p:leading-relaxed prose-p:text-text prose-a:text-accent"
    >
      <Content />
    </div>

    {
      episode.data.transcript && (
        <details class="mt-10 rounded-lg border border-border">
          <summary class="cursor-pointer px-4 py-3 text-sm font-medium text-text transition-colors hover:text-accent">
            Transcript
            <span class="ml-2 text-xs font-normal text-text-muted">
              ({episode.data.transcript.split(/\s+/).length.toLocaleString()} words)
            </span>
          </summary>
          <div class="relative px-4 pb-4">
            <button
              type="button"
              class="transcript-copy absolute right-4 top-0 rounded border border-border bg-surface-alt px-2 py-1 text-xs text-text-muted transition-colors hover:border-accent hover:text-accent"
              aria-label="Copy transcript"
            >
              Copy
            </button>
            <div class="transcript-text whitespace-pre-wrap pt-1 text-sm leading-relaxed text-text-muted">
              {episode.data.transcript}
            </div>
          </div>
        </details>
      )
    }

    <NotebookAssets
      videoUrl={episode.data.videoUrl}
      infographic={episode.data.infographic}
      mindmap={episode.data.mindmap}
      quiz={episode.data.quiz}
      flashcards={episode.data.flashcards}
      dataTable={episode.data.dataTable}
      slides={episode.data.slides}
      title={episode.data.title}
    />

    <RelatedContent currentTags={episode.data.tags} currentId={episode.id} currentDate={episode.data.date} contentType="audio" />

    <nav class="mt-16 grid gap-4 border-t border-border pt-8 sm:grid-cols-2" aria-label="Previous and next episodes">
      {
        prevEpisode ? (
          <a
            href={`/audio/${slug(prevEpisode.id)}/`}
            class="hover:border-accent/50 group rounded-lg border border-border p-4 no-underline transition-colors"
          >
            <span class="text-xs text-text-muted">&larr; Previous</span>
            <span class="mt-1 block text-sm font-medium text-text transition-colors group-hover:text-accent">
              {prevEpisode.data.title}
            </span>
          </a>
        ) : (
          <a href="/audio/" class="flex items-center text-sm text-text-muted transition-colors hover:text-accent">
            &larr; All episodes
          </a>
        )
      }
      {
        nextEpisode && (
          <a
            href={`/audio/${slug(nextEpisode.id)}/`}
            class="hover:border-accent/50 group rounded-lg border border-border p-4 no-underline transition-colors sm:text-right"
          >
            <span class="text-xs text-text-muted">Next &rarr;</span>
            <span class="mt-1 block text-sm font-medium text-text transition-colors group-hover:text-accent">
              {nextEpisode.data.title}
            </span>
          </a>
        )
      }
    </nav>
  </article>
  <script>
    const copyBtn = document.querySelector('.transcript-copy');
    const transcriptText = document.querySelector('.transcript-text');
    if (copyBtn && transcriptText) {
      copyBtn.addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(transcriptText.textContent || '');
          copyBtn.textContent = 'Copied!';
          setTimeout(() => { copyBtn.textContent = 'Copy'; }, 2000);
        } catch {
          copyBtn.textContent = 'Failed';
          setTimeout(() => { copyBtn.textContent = 'Copy'; }, 2000);
        }
      });
    }
  </script>
</BaseLayout>
