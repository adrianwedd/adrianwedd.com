---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { slug } from '../../../lib/utils';

export async function getStaticPaths() {
  const episodes = await getCollection('audio');
  const tags = [...new Set(episodes.flatMap((e) => e.data.tags))];
  return tags.map((tag) => ({
    params: { tag },
    props: {
      tag,
      episodes: episodes
        .filter((e) => e.data.tags.includes(tag))
        .sort((a, b) => b.data.date.getTime() - a.data.date.getTime()),
    },
  }));
}

const { tag, episodes } = Astro.props;

const allEpisodes = await getCollection('audio');
const allTags = [...new Set(allEpisodes.flatMap((e) => e.data.tags))].sort();
---

<BaseLayout title={`Audio tagged "${tag}"`} description={`Audio episodes tagged with ${tag}.`}>
  <section class="mx-auto max-w-4xl px-4 py-16 sm:px-6 lg:px-8">
    <h1 class="text-text">Tag: {tag}</h1>
    <p class="mt-2 text-text-muted">{episodes.length} episode{episodes.length !== 1 ? 's' : ''}</p>

    <nav class="mt-8 flex flex-wrap gap-2" aria-label="Filter by tag">
      <a
        href="/audio/"
        class="rounded-full border border-border px-3 py-1 text-xs text-text-muted no-underline transition-colors hover:border-accent hover:text-accent"
      >
        All
      </a>
      {
        allTags.map((t) => (
          <a
            href={`/audio/tag/${t}/`}
            class:list={[
              'rounded-full border px-3 py-1 text-xs no-underline',
              t === tag
                ? 'bg-accent/10 border-accent font-medium text-accent'
                : 'border-border text-text-muted transition-colors hover:border-accent hover:text-accent',
            ]}
          >
            {t}
          </a>
        ))
      }
    </nav>

    <div class="mt-10 space-y-6">
      {
        episodes.map((episode) => (
          <article>
            <a
              href={`/audio/${slug(episode.id)}/`}
              class="card-hover hover:border-accent/50 group block rounded-xl border border-border bg-surface-alt p-6 no-underline shadow-subtle transition-all hover:shadow-card"
            >
              <div class="flex items-start justify-between gap-4">
                <div>
                  <h2 class="text-lg font-semibold text-text transition-colors group-hover:text-accent">
                    {episode.data.title}
                  </h2>
                  <p class="mt-1 text-sm leading-relaxed text-text-muted">{episode.data.description}</p>
                  {episode.data.duration && (
                    <span class="mt-2 inline-block text-xs text-text-muted">{episode.data.duration}</span>
                  )}
                </div>
                <time class="whitespace-nowrap text-xs text-text-muted" datetime={episode.data.date.toISOString()}>
                  {episode.data.date.toLocaleDateString('en-AU', { day: 'numeric', month: 'short', year: 'numeric' })}
                </time>
              </div>
            </a>
          </article>
        ))
      }
    </div>
  </section>
</BaseLayout>
