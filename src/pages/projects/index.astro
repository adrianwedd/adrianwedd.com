---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { slug } from '../../lib/utils';
import fs from 'node:fs';

const allProjects = await getCollection('projects');
const projects = allProjects.sort((a, b) => {
  if (a.data.featured && !b.data.featured) return -1;
  if (!a.data.featured && b.data.featured) return 1;
  return b.data.date.getTime() - a.data.date.getTime();
});

const allTags = [...new Set(projects.flatMap((p) => p.data.tags))].sort();
const allStatuses = [...new Set(projects.map((p) => p.data.status))].sort();

const statusLabels: Record<string, string> = {
  active: 'Active',
  complete: 'Complete',
  archived: 'Archived',
  experiment: 'Experiment',
};

const statusColors: Record<string, string> = {
  active: 'border-green-700 text-green-400',
  complete: 'border-accent/30 text-accent',
  archived: 'border-border text-text-muted',
  experiment: 'border-purple-700 text-purple-400',
};

// Load auto-discovered repos from cached data
interface GitHubRepo {
  name: string;
  description: string;
  language: string;
  topics: string[];
  url: string;
  homepage: string;
  stars: number;
  forks: number;
  updated_at: string;
  fork: boolean;
  archived: boolean;
}

let discoveredRepos: GitHubRepo[] = [];
try {
  const reposPath = new URL('../../data/repos.json', import.meta.url);
  const raw = fs.readFileSync(reposPath, 'utf-8');
  const allRepos: GitHubRepo[] = JSON.parse(raw);

  // Exclude: forks, archived, repos that already have project pages, empty repos
  const existingSlugs = new Set(allProjects.map((p) => slug(p.id).toLowerCase()));
  discoveredRepos = allRepos
    .filter((r) => !r.fork && !r.archived && r.description && !existingSlugs.has(r.name.toLowerCase()))
    .sort((a, b) => new Date(b.updated_at).getTime() - new Date(a.updated_at).getTime())
    .slice(0, 12);
} catch {
  // No repos.json yet — sync-repos.sh hasn't run
}
---

<BaseLayout title="Projects" description="Things I've built, broken, and sometimes both.">
  <section class="mx-auto max-w-6xl px-4 py-16 sm:px-6 lg:px-8">
    <h1 class="text-text">Projects</h1>
    <p class="mt-4 max-w-prose text-text-muted">Things I've built, broken, and sometimes both.</p>

    {/* Status filter */}
    <div class="mt-8 flex flex-wrap gap-2" id="status-filters" aria-label="Filter by status">
      <button
        type="button"
        data-status=""
        class="status-filter bg-accent/10 cursor-pointer rounded-full border border-accent px-3 py-1 text-xs font-medium text-accent transition-colors"
        aria-pressed="true"
      >
        All
      </button>
      {
        allStatuses.map((status) => (
          <button
            type="button"
            data-status={status}
            class="status-filter cursor-pointer rounded-full border border-border px-3 py-1 text-xs text-text-muted transition-colors hover:border-accent hover:text-accent"
            aria-pressed="false"
          >
            {statusLabels[status] || status}
          </button>
        ))
      }
    </div>

    {/* Status legend */}
    <details class="mt-2">
      <summary class="cursor-pointer text-xs text-text-muted hover:text-accent">What do these mean?</summary>
      <div class="mt-2 grid grid-cols-2 gap-x-6 gap-y-1 text-xs text-text-muted sm:grid-cols-4">
        <p><span class="text-green-400">Active</span> — in development</p>
        <p><span class="text-accent">Complete</span> — finished, stable</p>
        <p><span class="text-text-muted">Archived</span> — no longer maintained</p>
        <p><span class="text-purple-400">Experiment</span> — exploratory, may not ship</p>
      </div>
    </details>

    {/* Tag filter */}
    {
      allTags.length > 0 && (
        <div class="mt-3 flex flex-wrap gap-2" id="tag-filters" aria-label="Filter by tag">
          <button
            type="button"
            data-tag=""
            class="tag-filter bg-accent/10 cursor-pointer rounded-full border border-accent px-3 py-1 text-xs font-medium text-accent transition-colors"
            aria-pressed="true"
          >
            All tags
          </button>
          {allTags.map((tag, i) => (
            <button
              type="button"
              data-tag={tag}
              class:list={[
                'tag-filter cursor-pointer rounded-full border border-border px-3 py-1 text-xs text-text-muted transition-colors hover:border-accent hover:text-accent',
                i >= 10 && 'project-tag-overflow hidden',
              ]}
              aria-pressed="false"
            >
              {tag}
            </button>
          ))}
          {allTags.length > 10 && (
            <button
              type="button"
              id="project-tags-toggle"
              class="cursor-pointer rounded-full border border-border px-3 py-1 text-xs text-text-muted transition-colors hover:border-accent hover:text-accent"
            >
              +{allTags.length - 10} more
            </button>
          )}
        </div>
      )
    }

    {/* Sort control */}
    <div class="mt-4 flex items-center gap-2">
      <label for="sort-select" class="text-xs text-text-muted">Sort:</label>
      <select
        id="sort-select"
        class="rounded border border-border bg-surface-alt px-2 py-1 text-xs text-text-muted focus:border-accent focus:outline-none"
      >
        <option value="featured">Featured first</option>
        <option value="newest">Newest first</option>
        <option value="oldest">Oldest first</option>
        <option value="alpha">A–Z</option>
      </select>
    </div>

    <div class="mt-6 grid gap-6 sm:grid-cols-2" id="project-grid">
      {
        projects.map((project) => (
          <article
            data-tags={JSON.stringify(project.data.tags)}
            data-status={project.data.status}
            data-featured={project.data.featured ? 'true' : ''}
            data-date={project.data.date.toISOString()}
            data-title={project.data.title}
            class="project-card transition-opacity duration-200"
          >
            <a
              href={`/projects/${slug(project.id)}/`}
              class="card-hover hover:border-accent/50 group block h-full rounded-xl border border-border bg-surface-alt p-6 no-underline shadow-subtle transition-all hover:shadow-card"
            >
              <div class="flex items-start justify-between gap-3">
                <h2 class="text-lg font-semibold text-text transition-colors group-hover:text-accent">
                  {project.data.title}
                </h2>
                <span
                  class:list={[
                    'whitespace-nowrap rounded-full border px-2 py-0.5 text-xs',
                    statusColors[project.data.status] || 'border-border text-text-muted',
                  ]}
                >
                  {statusLabels[project.data.status] || project.data.status}
                </span>
              </div>
              <p class="mt-2 text-sm leading-relaxed text-text-muted">{project.data.description}</p>
              <div class="mt-4 flex flex-wrap items-center gap-2">
                {project.data.tags.slice(0, 4).map((tag: string) => (
                  <span class="rounded-full border border-border bg-surface px-2 py-0.5 text-xs text-text-muted">
                    {tag}
                  </span>
                ))}
                <time class="ml-auto whitespace-nowrap text-xs text-text-muted" datetime={project.data.date.toISOString()}>
                  {project.data.date.toLocaleDateString('en-AU', { month: 'short', year: 'numeric' })}
                </time>
              </div>
            </a>
          </article>
        ))
      }
    </div>

    <p id="no-results" class="mt-10 hidden text-center text-text-muted">No projects match these filters.</p>

    {/* Auto-discovered repos from GitHub */}
    {discoveredRepos.length > 0 && (
      <section class="mt-16 border-t border-border pt-10">
        <h2 class="text-lg font-semibold text-text">More on GitHub</h2>
        <p class="mt-1 text-sm text-text-muted">Other public repos, auto-discovered from GitHub.</p>
        <div class="mt-6 grid gap-3 sm:grid-cols-2 lg:grid-cols-3">
          {discoveredRepos.map((repo) => (
            <a
              href={repo.url}
              target="_blank"
              rel="noopener"
              class="hover:border-accent/50 group block rounded-lg border border-border bg-surface-alt p-4 no-underline transition-all hover:shadow-card"
            >
              <div class="flex items-start justify-between gap-2">
                <h3 class="font-mono text-sm font-medium text-text transition-colors group-hover:text-accent">
                  {repo.name}
                </h3>
                {repo.language && (
                  <span class="shrink-0 rounded-full border border-border px-2 py-0.5 text-xs text-text-muted">
                    {repo.language}
                  </span>
                )}
              </div>
              <p class="mt-1 text-xs leading-relaxed text-text-muted line-clamp-2">
                {repo.description}
              </p>
              {repo.stars > 0 && (
                <span class="mt-2 inline-block text-xs text-text-muted">
                  ★ {repo.stars}
                </span>
              )}
            </a>
          ))}
        </div>
        <p class="mt-4 text-sm text-text-muted">
          <a
            href="https://github.com/adrianwedd?tab=repositories"
            target="_blank"
            rel="noopener"
            class="text-accent hover:underline"
          >
            View all repositories →
          </a>
        </p>
      </section>
    )}
  </section>

  <script>
    const grid = document.getElementById('project-grid')!;
    const cards = Array.from(document.querySelectorAll<HTMLElement>('.project-card'));
    const statusFilters = document.getElementById('status-filters')!;
    const tagFilters = document.getElementById('tag-filters')!;
    const sortSelect = document.getElementById('sort-select') as HTMLSelectElement;
    const noResults = document.getElementById('no-results')!;

    let activeStatus = '';
    let activeTag = '';

    // Read URL params on load
    const params = new URLSearchParams(window.location.search);
    if (params.get('status')) activeStatus = params.get('status')!;
    if (params.get('tag')) activeTag = params.get('tag')!;
    if (params.get('sort')) sortSelect.value = params.get('sort')!;

    function setActiveButton(container: HTMLElement, cls: string, value: string, attr: string) {
      container.querySelectorAll(`.${cls}`).forEach((b) => {
        const el = b as HTMLElement;
        const match = (el.dataset[attr] || '') === value;
        el.classList.toggle('border-accent', match);
        el.classList.toggle('bg-accent/10', match);
        el.classList.toggle('text-accent', match);
        el.classList.toggle('font-medium', match);
        el.classList.toggle('border-border', !match);
        el.classList.toggle('text-text-muted', !match);
        el.setAttribute('aria-pressed', match ? 'true' : 'false');
      });
    }

    function updateURL() {
      const p = new URLSearchParams();
      if (activeStatus) p.set('status', activeStatus);
      if (activeTag) p.set('tag', activeTag);
      if (sortSelect.value !== 'featured') p.set('sort', sortSelect.value);
      const qs = p.toString();
      history.replaceState(null, '', qs ? `?${qs}` : window.location.pathname);
    }

    function applyFilters() {
      let visible = 0;
      cards.forEach((card) => {
        const matchStatus = !activeStatus || card.dataset.status === activeStatus;
        const matchTag = !activeTag || (JSON.parse(card.dataset.tags || '[]') as string[]).includes(activeTag);
        const show = matchStatus && matchTag;
        card.style.opacity = show ? '1' : '0';
        setTimeout(() => { card.style.display = show ? '' : 'none'; }, show ? 0 : 200);
        if (show) visible++;
      });
      noResults.classList.toggle('hidden', visible > 0);
      updateURL();
    }

    function applySort() {
      const sorted = [...cards].sort((a, b) => {
        const sort = sortSelect.value;
        if (sort === 'featured') {
          const af = a.dataset.featured ? 1 : 0;
          const bf = b.dataset.featured ? 1 : 0;
          if (af !== bf) return bf - af;
          return new Date(b.dataset.date!).getTime() - new Date(a.dataset.date!).getTime();
        }
        if (sort === 'newest') return new Date(b.dataset.date!).getTime() - new Date(a.dataset.date!).getTime();
        if (sort === 'oldest') return new Date(a.dataset.date!).getTime() - new Date(b.dataset.date!).getTime();
        return (a.dataset.title || '').localeCompare(b.dataset.title || '');
      });
      sorted.forEach((card) => grid.appendChild(card));
      updateURL();
    }

    statusFilters.addEventListener('click', (e) => {
      const btn = (e.target as HTMLElement).closest<HTMLButtonElement>('.status-filter');
      if (!btn) return;
      activeStatus = btn.dataset.status || '';
      setActiveButton(statusFilters, 'status-filter', activeStatus, 'status');
      applyFilters();
    });

    tagFilters.addEventListener('click', (e) => {
      const btn = (e.target as HTMLElement).closest<HTMLButtonElement>('.tag-filter');
      if (!btn) return;
      activeTag = btn.dataset.tag || '';
      setActiveButton(tagFilters, 'tag-filter', activeTag, 'tag');
      applyFilters();
    });

    sortSelect.addEventListener('change', () => {
      applySort();
      applyFilters();
    });

    // Tag overflow toggle
    const tagToggle = document.getElementById('project-tags-toggle');
    if (tagToggle) {
      let expanded = false;
      tagToggle.dataset.label = tagToggle.textContent || '';
      tagToggle.addEventListener('click', () => {
        expanded = !expanded;
        document.querySelectorAll('.project-tag-overflow').forEach((el) => {
          (el as HTMLElement).classList.toggle('hidden', !expanded);
        });
        tagToggle.textContent = expanded ? 'Show less' : tagToggle.dataset.label || '';
      });
    }

    // Apply initial state from URL
    setActiveButton(statusFilters, 'status-filter', activeStatus, 'status');
    setActiveButton(tagFilters, 'tag-filter', activeTag, 'tag');
    applySort();
    applyFilters();
  </script>
</BaseLayout>
