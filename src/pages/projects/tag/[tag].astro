---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { slug } from '../../../lib/utils';

export async function getStaticPaths() {
  const projects = await getCollection('projects');
  const tags = [...new Set(projects.flatMap((p) => p.data.tags))];
  return tags.map((tag) => ({
    params: { tag },
    props: {
      tag,
      projects: projects
        .filter((p) => p.data.tags.includes(tag))
        .sort((a, b) => b.data.date.getTime() - a.data.date.getTime()),
    },
  }));
}

const { tag, projects } = Astro.props;

const allProjects = await getCollection('projects');
const allTags = [...new Set(allProjects.flatMap((p) => p.data.tags))].sort();

const statusColors: Record<string, string> = {
  active: 'text-green-400',
  complete: 'text-accent',
  archived: 'text-text-muted',
  experiment: 'text-purple-400',
};
---

<BaseLayout title={`Projects tagged "${tag}"`} description={`Projects tagged with ${tag}.`}>
  <section class="mx-auto max-w-4xl px-4 py-16 sm:px-6 lg:px-8">
    <h1 class="text-text">Tag: {tag}</h1>
    <p class="mt-2 text-text-muted">{projects.length} project{projects.length !== 1 ? 's' : ''}</p>

    <nav class="mt-8 flex flex-wrap gap-2" aria-label="Filter by tag">
      <a
        href="/projects/"
        class="rounded-full border border-border px-3 py-1 text-xs text-text-muted no-underline transition-colors hover:border-accent hover:text-accent"
      >
        All
      </a>
      {
        allTags.map((t) => (
          <a
            href={`/projects/tag/${t}/`}
            class:list={[
              'rounded-full border px-3 py-1 text-xs no-underline',
              t === tag
                ? 'bg-accent/10 border-accent font-medium text-accent'
                : 'border-border text-text-muted transition-colors hover:border-accent hover:text-accent',
            ]}
          >
            {t}
          </a>
        ))
      }
    </nav>

    <div class="mt-10 space-y-8">
      {
        projects.map((project) => (
          <article>
            <a
              href={`/projects/${slug(project.id)}/`}
              class="card-hover hover:border-accent/50 group block rounded-xl border border-border bg-surface-alt p-6 no-underline shadow-subtle transition-all hover:shadow-card"
            >
              <div class="flex items-start justify-between gap-4">
                <div>
                  <h2 class="text-xl font-semibold text-text transition-colors group-hover:text-accent">
                    {project.data.title}
                  </h2>
                  <p class="mt-1 text-sm leading-relaxed text-text-muted">{project.data.description}</p>
                </div>
                <div class="flex flex-col items-end gap-1">
                  <time class="whitespace-nowrap text-xs text-text-muted" datetime={project.data.date.toISOString()}>
                    {project.data.date.toLocaleDateString('en-AU', { day: 'numeric', month: 'short', year: 'numeric' })}
                  </time>
                  {project.data.status && (
                    <span class={`text-xs ${statusColors[project.data.status] || 'text-text-muted'}`}>
                      {project.data.status}
                    </span>
                  )}
                </div>
              </div>
            </a>
          </article>
        ))
      }
    </div>
  </section>
</BaseLayout>
