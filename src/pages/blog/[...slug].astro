---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Breadcrumb from '../../components/Breadcrumb.astro';
import TableOfContents from '../../components/islands/TableOfContents';
import ShareButton from '../../components/islands/ShareButton';
import RelatedContent from '../../components/RelatedContent.astro';
import NotebookAssets from '../../components/NotebookAssets.astro';
import { getCollection, render } from 'astro:content';
import { slug } from '../../lib/utils';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map((post) => ({
    params: { slug: post.id.replace(/\.mdx?$/, '') },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await render(post);

const allPosts = (await getCollection('blog'))
  .filter((p) => !p.data.draft)
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

const currentIndex = allPosts.findIndex((p) => p.id === post.id);
const prevPost = currentIndex < allPosts.length - 1 ? allPosts[currentIndex + 1] : null;
const nextPost = currentIndex > 0 ? allPosts[currentIndex - 1] : null;

// Reading time estimate
const words = post.body ? post.body.split(/\s+/).length : 0;
const readingTime = Math.max(1, Math.ceil(words / 200));

// OG image: use heroImage if set, otherwise generated OG image
const postSlug = slug(post.id);
const ogImage = post.data.heroImage || `/og/${postSlug}.png`;

// Series support
const seriesPosts = post.data.series
  ? allPosts
      .filter((p) => p.data.series === post.data.series)
      .sort((a, b) => (a.data.seriesOrder ?? 0) - (b.data.seriesOrder ?? 0))
  : [];
---

<BaseLayout
  title={post.data.title}
  description={post.data.description}
  image={ogImage}
  type="article"
  publishedDate={post.data.date.toISOString()}
  tags={post.data.tags}
>
  {/* Reading progress bar */}
  <div
    id="reading-progress"
    class="fixed left-0 top-16 z-40 h-0.5 bg-accent transition-[width] duration-100"
    style="width: 0%"
    role="progressbar"
    aria-label="Reading progress"
    aria-valuemin="0"
    aria-valuemax="100"
    aria-valuenow="0"
  ></div>
  <div
    id="reading-remaining"
    class="fixed right-4 top-[4.25rem] z-40 rounded-full border border-border bg-surface-alt px-2.5 py-0.5 text-xs text-text-muted opacity-0 transition-opacity duration-300"
    aria-live="off"
  ></div>

  <article class="mx-auto max-w-3xl px-4 py-16 sm:px-6 lg:px-8">
    <Breadcrumb
      crumbs={[{ label: 'Home', href: '/' }, { label: 'Blog', href: '/blog/' }, { label: post.data.title }]}
    />
    <header class="mb-10">
      <div class="mb-4 flex items-center gap-3 text-sm text-text-muted">
        <time datetime={post.data.date.toISOString()}>
          {post.data.date.toLocaleDateString('en-AU', { day: 'numeric', month: 'long', year: 'numeric' })}
        </time>
        {post.data.updatedDate && (
          <>
            <span aria-hidden="true">&middot;</span>
            <span>
              Updated <time datetime={post.data.updatedDate.toISOString()}>
                {post.data.updatedDate.toLocaleDateString('en-AU', { day: 'numeric', month: 'long', year: 'numeric' })}
              </time>
            </span>
          </>
        )}
        <span aria-hidden="true">&middot;</span>
        <span>{readingTime} min read</span>
      </div>
      <h1 class="text-text">{post.data.title}</h1>
      <p class="mt-4 text-lg leading-relaxed text-text-muted">{post.data.description}</p>
      <div class="mt-4 flex flex-wrap items-center gap-2">
        {
          post.data.tags.map((tag: string) => (
            <a
              href={`/blog/tag/${tag}/`}
              class="rounded-full border border-border bg-surface-alt px-2 py-0.5 text-xs text-text-muted no-underline transition-colors hover:border-accent hover:text-accent"
            >
              {tag}
            </a>
          ))
        }
        <span class="ml-auto">
          <ShareButton title={post.data.title} url={`/blog/${slug(post.id)}/`} client:idle />
        </span>
      </div>
    </header>

    {
      seriesPosts.length > 1 && (
        <nav class="mb-8 rounded-lg border border-border bg-surface-alt p-4" aria-label="Series navigation">
          <p class="mb-2 text-xs font-medium text-text-muted">
            Part {seriesPosts.findIndex((p) => p.id === post.id) + 1} of {seriesPosts.length} in <span class="text-accent">{post.data.series}</span>
          </p>
          <ol class="space-y-1">
            {seriesPosts.map((p, i) => (
              <li class="text-sm">
                {p.id === post.id ? (
                  <span class="font-medium text-accent">{i + 1}. {p.data.title}</span>
                ) : (
                  <a
                    href={`/blog/${slug(p.id)}/`}
                    class="text-text-muted no-underline transition-colors hover:text-accent"
                  >
                    {i + 1}. {p.data.title}
                  </a>
                )}
              </li>
            ))}
          </ol>
        </nav>
      )
    }

    <TableOfContents contentSelector=".prose" client:idle />

    <div
      class="prose max-w-none prose-headings:mb-4 prose-headings:mt-8 prose-headings:font-semibold prose-headings:text-text prose-p:mb-4 prose-p:leading-relaxed prose-p:text-text prose-a:text-accent prose-a:no-underline hover:prose-a:underline prose-blockquote:my-4 prose-blockquote:border-accent prose-blockquote:text-text-muted prose-strong:text-text prose-code:rounded prose-code:bg-surface-alt prose-code:px-1 prose-code:py-0.5 prose-code:text-text-accent prose-pre:my-4 prose-pre:border prose-pre:border-border prose-pre:bg-surface-alt prose-ol:my-4 prose-ul:my-4 prose-li:text-text"
    >
      <Content />
    </div>

    <NotebookAssets
      audioUrl={post.data.audioUrl}
      videoUrl={post.data.videoUrl}
      infographic={post.data.infographic}
      mindmap={post.data.mindmap}
      quiz={post.data.quiz}
      flashcards={post.data.flashcards}
      dataTable={post.data.dataTable}
      slides={post.data.slides}
      title={post.data.title}
    />

    <RelatedContent currentTags={post.data.tags} currentId={post.id} currentDate={post.data.date} contentType="blog" />

    {/* Prev/Next navigation */}
    <nav class="mt-16 grid gap-4 border-t border-border pt-8 sm:grid-cols-2" aria-label="Previous and next posts">
      {
        prevPost ? (
          <a
            href={`/blog/${slug(prevPost.id)}/`}
            class="hover:border-accent/50 group rounded-lg border border-border p-4 no-underline transition-colors"
          >
            <span class="text-xs text-text-muted">&larr; Previous</span>
            <span class="mt-1 block text-sm font-medium text-text transition-colors group-hover:text-accent">
              {prevPost.data.title}
            </span>
          </a>
        ) : (
          <div />
        )
      }
      {
        nextPost && (
          <a
            href={`/blog/${slug(nextPost.id)}/`}
            class="hover:border-accent/50 group rounded-lg border border-border p-4 no-underline transition-colors sm:text-right"
          >
            <span class="text-xs text-text-muted">Next &rarr;</span>
            <span class="mt-1 block text-sm font-medium text-text transition-colors group-hover:text-accent">
              {nextPost.data.title}
            </span>
          </a>
        )
      }
    </nav>
  </article>

  <script>
    const bar = document.getElementById('reading-progress');
    const remaining = document.getElementById('reading-remaining');
    const article = document.querySelector('article');
    if (bar && article) {
      const totalReadMin = Math.max(1, Math.ceil((article.textContent?.split(/\s+/).length || 0) / 200));
      const update = () => {
        const rect = article.getBoundingClientRect();
        const total = article.scrollHeight - window.innerHeight;
        const scrolled = -rect.top;
        const pct = Math.min(100, Math.max(0, (scrolled / total) * 100));
        bar.style.width = `${pct}%`;
        bar.setAttribute('aria-valuenow', String(Math.round(pct)));
        if (remaining) {
          const minLeft = Math.max(0, Math.ceil(totalReadMin * (1 - pct / 100)));
          if (pct > 5 && pct < 98) {
            remaining.textContent = minLeft <= 1 ? '< 1 min left' : `${minLeft} min left`;
            remaining.style.opacity = '1';
          } else {
            remaining.style.opacity = '0';
          }
        }
      };
      window.addEventListener('scroll', update, { passive: true });
      update();
    }
  </script>
</BaseLayout>
