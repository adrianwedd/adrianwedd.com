---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { slug } from '../../lib/utils';

const allPosts = await getCollection('blog');
const posts = allPosts
  .filter(p => !p.data.draft)
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

const allTags = [...new Set(posts.flatMap(p => p.data.tags))].sort();
---

<BaseLayout
  title="Blog"
  description="Essays, technical writing, and thinking out loud."
>
  <section class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
    <h1 class="text-text">Blog</h1>
    <p class="mt-4 text-text-muted max-w-prose">
      Essays, technical writing, and thinking out loud.
    </p>

    {/* Tag filter */}
    {allTags.length > 0 && (
      <nav class="mt-8 flex flex-wrap gap-2" aria-label="Filter by tag">
        <a
          href="/blog/"
          class="text-xs px-3 py-1 rounded-full border border-accent bg-accent/10 text-accent font-medium no-underline"
        >
          All
        </a>
        {allTags.map(tag => (
          <a
            href={`/blog/tag/${tag}/`}
            class="text-xs px-3 py-1 rounded-full border border-border text-text-muted hover:border-accent hover:text-accent transition-colors no-underline"
          >
            {tag}
          </a>
        ))}
      </nav>
    )}

    {/* Post list */}
    <div class="mt-10 space-y-8">
      {posts.map(post => (
        <article>
          <a href={`/blog/${slug(post.id)}/`} class="group block p-6 rounded-xl bg-surface-alt border border-border shadow-subtle hover:shadow-card card-hover hover:border-accent/50 transition-all no-underline">
            <div class="flex items-start justify-between gap-4">
              <div>
                <h2 class="text-xl font-semibold text-text group-hover:text-accent transition-colors">
                  {post.data.title}
                </h2>
                <p class="mt-1 text-sm text-text-muted leading-relaxed">
                  {post.data.description}
                </p>
                <div class="mt-2 flex flex-wrap gap-2">
                  {post.data.tags.map((tag: string) => (
                    <span class="text-xs px-2 py-0.5 rounded-full bg-surface-alt border border-border text-text-muted">
                      {tag}
                    </span>
                  ))}
                </div>
              </div>
              <time class="text-xs text-text-muted whitespace-nowrap" datetime={post.data.date.toISOString()}>
                {post.data.date.toLocaleDateString('en-AU', { day: 'numeric', month: 'short', year: 'numeric' })}
              </time>
            </div>
          </a>
        </article>
      ))}
    </div>
  </section>
</BaseLayout>
