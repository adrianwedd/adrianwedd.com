---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import Breadcrumb from '../../../components/Breadcrumb.astro';
import ShareButton from '../../../components/islands/ShareButton';
import { getCollection } from 'astro:content';
import { slug, imageSlug } from '../../../lib/utils';

interface ImageData {
  src: string;
  alt: string;
  caption?: string;
}

export async function getStaticPaths() {
  const galleries = await getCollection('gallery');
  const paths: Array<{
    params: { collection: string; image: string };
    props: {
      gallery: (typeof galleries)[0];
      image: ImageData;
      imageIndex: number;
      total: number;
      prevSlug: string | null;
      nextSlug: string | null;
    };
  }> = [];

  for (const gallery of galleries) {
    const collectionSlug = slug(gallery.id);
    const images = gallery.data.images;

    for (let i = 0; i < images.length; i++) {
      const img = images[i];
      paths.push({
        params: {
          collection: collectionSlug,
          image: imageSlug(img.alt),
        },
        props: {
          gallery,
          image: img,
          imageIndex: i,
          total: images.length,
          prevSlug: i > 0 ? imageSlug(images[i - 1].alt) : null,
          nextSlug: i < images.length - 1 ? imageSlug(images[i + 1].alt) : null,
        },
      });
    }
  }

  return paths;
}

const { gallery, image, imageIndex, total, prevSlug, nextSlug } = Astro.props;
const collectionSlug = slug(gallery.id);
---

<BaseLayout
  title={`${image.alt} â€” ${gallery.data.title}`}
  description={image.caption || image.alt}
  image={image.src}
  type="article"
  tags={gallery.data.tags}
>
  <script
    type="application/ld+json"
    set:html={JSON.stringify({
      '@context': 'https://schema.org',
      '@type': 'ImageObject',
      name: image.alt,
      contentUrl: new URL(image.src, Astro.site).href,
      ...(image.caption ? { caption: image.caption } : {}),
      isPartOf: {
        '@type': 'ImageGallery',
        name: gallery.data.title,
        url: new URL(`/gallery/${collectionSlug}/`, Astro.site).href,
      },
      author: {
        '@type': 'Person',
        name: 'Adrian Wedd',
        url: 'https://adrianwedd.com',
      },
    })}
  />
  <article class="mx-auto max-w-5xl px-4 py-16 sm:px-6 lg:px-8">
    <Breadcrumb
      crumbs={[
        { label: 'Home', href: '/' },
        { label: 'Gallery', href: '/gallery/' },
        { label: gallery.data.title, href: `/gallery/${collectionSlug}/` },
        { label: image.alt },
      ]}
    />

    {/* Image */}
    <figure class="mb-8">
      <div class="overflow-hidden rounded-lg border border-border bg-surface-alt">
        <img
          src={image.src}
          alt={image.alt}
          width="1200"
          height="900"
          class="w-full"
          loading="eager"
          fetchpriority="high"
        />
      </div>
      {image.caption && (
        <figcaption class="mt-3 text-sm text-text-muted">{image.caption}</figcaption>
      )}
    </figure>

    {/* Metadata */}
    <div class="mb-8 flex flex-wrap items-center gap-3 text-sm text-text-muted">
      <span>{imageIndex + 1} of {total}</span>
      <span aria-hidden="true">&middot;</span>
      <span>Collection: <a href={`/gallery/${collectionSlug}/`} class="text-accent hover:underline">{gallery.data.title}</a></span>
      {gallery.data.medium && (
        <>
          <span aria-hidden="true">&middot;</span>
          <span>{gallery.data.medium}</span>
        </>
      )}
      <span class="ml-auto">
        <ShareButton title={image.alt} url={`/gallery/${collectionSlug}/${imageSlug(image.alt)}/`} client:idle />
      </span>
    </div>

    {/* Tags */}
    <div class="mb-8 flex flex-wrap gap-2">
      {gallery.data.tags.map((tag: string) => (
        <a
          href={`/gallery/tag/${tag}/`}
          class="rounded-full border border-border bg-surface-alt px-2 py-0.5 text-xs text-text-muted no-underline transition-colors hover:border-accent hover:text-accent"
        >
          {tag}
        </a>
      ))}
    </div>

    {/* Prev/Next navigation */}
    <nav class="grid gap-4 border-t border-border pt-8 sm:grid-cols-2" aria-label="Previous and next images">
      {prevSlug ? (
        <a
          href={`/gallery/${collectionSlug}/${prevSlug}/`}
          class="hover:border-accent/50 group rounded-lg border border-border p-4 no-underline transition-colors"
        >
          <span class="text-xs text-text-muted">&larr; Previous</span>
          <span class="mt-1 block text-sm font-medium text-text transition-colors group-hover:text-accent">
            {gallery.data.images[imageIndex - 1].alt}
          </span>
        </a>
      ) : (
        <div />
      )}
      {nextSlug && (
        <a
          href={`/gallery/${collectionSlug}/${nextSlug}/`}
          class="hover:border-accent/50 group rounded-lg border border-border p-4 no-underline transition-colors sm:text-right"
        >
          <span class="text-xs text-text-muted">Next &rarr;</span>
          <span class="mt-1 block text-sm font-medium text-text transition-colors group-hover:text-accent">
            {gallery.data.images[imageIndex + 1].alt}
          </span>
        </a>
      )}
    </nav>
  </article>
</BaseLayout>
