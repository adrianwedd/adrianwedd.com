---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Breadcrumb from '../../components/Breadcrumb.astro';
import RelatedContent from '../../components/RelatedContent.astro';
import ShareButton from '../../components/islands/ShareButton';
import Lightbox from '../../components/Lightbox.astro';
import { getCollection, render } from 'astro:content';
import { slug, imageSlug } from '../../lib/utils';

export async function getStaticPaths() {
  const galleries = await getCollection('gallery');
  return galleries.map((gallery) => ({
    params: { slug: slug(gallery.id) },
    props: { gallery },
  }));
}

const { gallery } = Astro.props;
const collectionSlug = slug(gallery.id);
const { Content } = await render(gallery);

const allGalleries = (await getCollection('gallery'))
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime());
const currentIndex = allGalleries.findIndex((g) => g.id === gallery.id);
const prevGallery = currentIndex < allGalleries.length - 1 ? allGalleries[currentIndex + 1] : null;
const nextGallery = currentIndex > 0 ? allGalleries[currentIndex - 1] : null;
---

<BaseLayout
  title={gallery.data.title}
  description={gallery.data.description || `Gallery: ${gallery.data.title}`}
  image={gallery.data.coverImage}
  type="article"
  tags={gallery.data.tags}
>
  <script
    type="application/ld+json"
    set:html={JSON.stringify({
      '@context': 'https://schema.org',
      '@type': 'ImageGallery',
      name: gallery.data.title,
      description: gallery.data.description || `Gallery: ${gallery.data.title}`,
      url: new URL(Astro.url.pathname, Astro.site).href,
      datePublished: gallery.data.date.toISOString(),
      image: gallery.data.images.map((img: { src: string; alt: string; caption?: string }) => ({
        '@type': 'ImageObject',
        contentUrl: new URL(img.src, Astro.site).href,
        name: img.alt,
        ...(img.caption ? { caption: img.caption } : {}),
      })),
      keywords: gallery.data.tags,
      author: {
        '@type': 'Person',
        name: 'Adrian Wedd',
        url: 'https://adrianwedd.com',
      },
    })}
  />
  <article class="mx-auto max-w-6xl px-4 py-16 sm:px-6 lg:px-8">
    <Breadcrumb
      crumbs={[{ label: 'Home', href: '/' }, { label: 'Gallery', href: '/gallery/' }, { label: gallery.data.title }]}
    />
    <header class="mb-10 max-w-3xl">
      <h1 class="text-text">{gallery.data.title}</h1>
      {
        gallery.data.description && (
          <p class="mt-4 text-lg leading-relaxed text-text-muted">{gallery.data.description}</p>
        )
      }
      <div class="mt-4 flex flex-wrap items-center gap-2">
        {
          gallery.data.tags.map((tag: string) => (
            <a
              href={`/gallery/tag/${tag}/`}
              class="rounded-full border border-border bg-surface-alt px-2 py-0.5 text-xs text-text-muted no-underline transition-colors hover:border-accent hover:text-accent"
            >
              {tag}
            </a>
          ))
        }
        <span class="ml-auto">
          <ShareButton title={gallery.data.title} url={`/gallery/${collectionSlug}/`} client:idle />
        </span>
      </div>
    </header>

    {/* Narrative text */}
    <div
      class="prose prose-invert mb-10 max-w-3xl prose-headings:text-text prose-p:leading-relaxed prose-p:text-text prose-a:text-accent"
    >
      <Content />
    </div>

    {/* Image grid */}
    <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3" id="gallery-grid">
      {
        gallery.data.images.map((image: { src: string; alt: string; caption?: string }, index: number) => (
          <a
            href={`/gallery/${collectionSlug}/${imageSlug(image.alt)}/`}
            class="gallery-trigger hover:border-accent/50 group block w-full overflow-hidden rounded-lg border border-border no-underline transition-all"
            data-index={index}
          >
            <div class="img-placeholder aspect-[4/3] overflow-hidden">
              <img
                src={image.src}
                alt={image.alt}
                width="400"
                height="300"
                class="h-full w-full object-cover transition-transform duration-300 group-hover:scale-105"
                loading="lazy"
                decoding="async"
              />
            </div>
            {image.caption && <p class="p-2 text-xs text-text-muted">{image.caption}</p>}
          </a>
        ))
      }
    </div>

    <Lightbox images={gallery.data.images} />

    <RelatedContent currentTags={gallery.data.tags} currentId={gallery.id} currentDate={gallery.data.date} contentType="gallery" />

    <nav class="mt-16 grid gap-4 border-t border-border pt-8 sm:grid-cols-2" aria-label="Previous and next collections">
      {
        prevGallery ? (
          <a
            href={`/gallery/${slug(prevGallery.id)}/`}
            class="hover:border-accent/50 group rounded-lg border border-border p-4 no-underline transition-colors"
          >
            <span class="text-xs text-text-muted">&larr; Previous</span>
            <span class="mt-1 block text-sm font-medium text-text transition-colors group-hover:text-accent">
              {prevGallery.data.title}
            </span>
          </a>
        ) : (
          <a href="/gallery/" class="flex items-center text-sm text-text-muted transition-colors hover:text-accent">
            &larr; All collections
          </a>
        )
      }
      {
        nextGallery && (
          <a
            href={`/gallery/${slug(nextGallery.id)}/`}
            class="hover:border-accent/50 group rounded-lg border border-border p-4 no-underline transition-colors sm:text-right"
          >
            <span class="text-xs text-text-muted">Next &rarr;</span>
            <span class="mt-1 block text-sm font-medium text-text transition-colors group-hover:text-accent">
              {nextGallery.data.title}
            </span>
          </a>
        )
      }
    </nav>
  </article>
</BaseLayout>
