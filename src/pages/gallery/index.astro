---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { slug } from '../../lib/utils';

const collections = (await getCollection('gallery')).sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

const allTags = [...new Set(collections.flatMap((c) => c.data.tags))].sort();
const allMedia = [...new Set(collections.map((c) => c.data.medium).filter(Boolean))].sort();
---

<BaseLayout
  title="Gallery"
  description="Visual thinking—process documentation, experiments that didn't need words, and patterns noticed before they had names."
>
  <section class="mx-auto max-w-6xl px-4 py-16 sm:px-6 lg:px-8">
    <h1 class="text-text">Gallery</h1>
    <p class="mt-4 max-w-prose text-text-muted">
      Visual thinking—process documentation, experiments that didn't need words, and patterns noticed before they had
      names.
    </p>

    {
      (allTags.length > 0 || allMedia.length > 0) && (
        <nav class="mt-8 flex flex-wrap gap-2" id="tag-filters" aria-label="Filter gallery">
          <button
            type="button"
            data-tag=""
            class="tag-filter bg-accent/10 cursor-pointer rounded-full border border-accent px-3 py-1 text-xs font-medium text-accent transition-colors"
            aria-pressed="true"
          >
            All
          </button>
          {allMedia.map((medium) => (
            <button
              type="button"
              data-tag={`medium:${medium}`}
              class="tag-filter cursor-pointer rounded-full border border-accent/30 px-3 py-1 text-xs italic text-accent transition-colors hover:border-accent"
              aria-pressed="false"
            >
              {medium}
            </button>
          ))}
          {allTags.map((tag, i) => (
            <button
              type="button"
              data-tag={tag}
              class:list={[
                'tag-filter cursor-pointer rounded-full border border-border px-3 py-1 text-xs text-text-muted no-underline transition-colors hover:border-accent hover:text-accent',
                i >= 10 && 'gallery-tag-overflow hidden',
              ]}
              aria-pressed="false"
            >
              {tag}
            </button>
          ))}
          {allTags.length > 10 && (
            <button
              type="button"
              id="gallery-tags-toggle"
              class="cursor-pointer rounded-full border border-border px-3 py-1 text-xs text-text-muted transition-colors hover:border-accent hover:text-accent"
            >
              +{allTags.length - 10} more
            </button>
          )}
        </nav>
      )
    }

    {/* Sort control */}
    <div class="mt-4 flex items-center gap-2">
      <label for="sort-select" class="text-xs text-text-muted">Sort:</label>
      <select
        id="sort-select"
        class="rounded border border-border bg-surface-alt px-2 py-1 text-xs text-text-muted focus:border-accent focus:outline-none"
      >
        <option value="newest">Newest first</option>
        <option value="oldest">Oldest first</option>
        <option value="alpha">A–Z</option>
      </select>
    </div>

    <div class="mt-6 grid gap-6 sm:grid-cols-2 lg:grid-cols-3" id="gallery-grid">
      {
        collections.map((collection) => (
          <article
            class="gallery-card transition-opacity duration-200"
            data-tags={JSON.stringify(collection.data.tags)}
            data-medium={collection.data.medium || ''}
            data-date={collection.data.date.toISOString()}
            data-title={collection.data.title}
          >
            <a
              href={`/gallery/${slug(collection.id)}/`}
              class="card-hover hover:border-accent/50 group block overflow-hidden rounded-xl border border-border no-underline shadow-subtle transition-all hover:shadow-card"
            >
              {collection.data.coverImage && (
                <div class="img-placeholder aspect-[4/3] overflow-hidden">
                  <img
                    src={collection.data.coverImage}
                    alt={collection.data.title}
                    class="h-full w-full object-cover transition-transform duration-300 group-hover:scale-105"
                    loading="lazy"
                  />
                </div>
              )}
              <div class="p-4">
                <h2 class="text-base font-semibold text-text transition-colors group-hover:text-accent">
                  {collection.data.title}
                </h2>
                {collection.data.description && (
                  <p class="mt-1 line-clamp-2 text-sm text-text-muted">{collection.data.description}</p>
                )}
                <div class="mt-2 flex items-center gap-2 text-xs text-text-muted">
                  <span>
                    {collection.data.images.length} image{collection.data.images.length !== 1 ? 's' : ''}
                  </span>
                  {collection.data.medium && (
                    <>
                      <span aria-hidden="true">&middot;</span>
                      <span>{collection.data.medium}</span>
                    </>
                  )}
                </div>
              </div>
            </a>
          </article>
        ))
      }
    </div>

    <p id="no-results" class="mt-10 hidden text-center text-text-muted">No collections match this filter.</p>
  </section>

  <script>
    const grid = document.getElementById('gallery-grid')!;
    const cards = Array.from(document.querySelectorAll<HTMLElement>('.gallery-card'));
    const tagFilters = document.getElementById('tag-filters');
    const sortSelect = document.getElementById('sort-select') as HTMLSelectElement;
    const noResults = document.getElementById('no-results')!;

    let activeTag = '';

    function applyFilters() {
      let visible = 0;
      cards.forEach((card) => {
        let match = true;
        if (activeTag) {
          if (activeTag.startsWith('medium:')) {
            match = card.dataset.medium === activeTag.replace('medium:', '');
          } else {
            match = (JSON.parse(card.dataset.tags || '[]') as string[]).includes(activeTag);
          }
        }
        card.style.opacity = match ? '1' : '0';
        setTimeout(() => { card.style.display = match ? '' : 'none'; }, match ? 0 : 200);
        if (match) visible++;
      });
      noResults.classList.toggle('hidden', visible > 0);
    }

    function applySort() {
      const sorted = [...cards].sort((a, b) => {
        const sort = sortSelect.value;
        if (sort === 'newest') return new Date(b.dataset.date!).getTime() - new Date(a.dataset.date!).getTime();
        if (sort === 'oldest') return new Date(a.dataset.date!).getTime() - new Date(b.dataset.date!).getTime();
        return (a.dataset.title || '').localeCompare(b.dataset.title || '');
      });
      sorted.forEach((card) => grid.appendChild(card));
    }

    function setActiveButton(value: string) {
      tagFilters?.querySelectorAll('.tag-filter').forEach((b) => {
        const el = b as HTMLElement;
        const match = (el.dataset.tag || '') === value;
        el.classList.toggle('border-accent', match);
        el.classList.toggle('bg-accent/10', match);
        el.classList.toggle('text-accent', match);
        el.classList.toggle('font-medium', match);
        el.classList.toggle('border-border', !match && !el.classList.contains('italic'));
        el.classList.toggle('text-text-muted', !match && !el.classList.contains('italic'));
        el.setAttribute('aria-pressed', match ? 'true' : 'false');
      });
    }

    // Tag overflow toggle
    const tagToggle = document.getElementById('gallery-tags-toggle');
    if (tagToggle) {
      let expanded = false;
      tagToggle.dataset.label = tagToggle.textContent || '';
      tagToggle.addEventListener('click', () => {
        expanded = !expanded;
        document.querySelectorAll('.gallery-tag-overflow').forEach((el) => {
          (el as HTMLElement).classList.toggle('hidden', !expanded);
        });
        tagToggle.textContent = expanded ? 'Show less' : tagToggle.dataset.label || '';
      });
    }

    tagFilters?.addEventListener('click', (e) => {
      const btn = (e.target as HTMLElement).closest<HTMLButtonElement>('.tag-filter');
      if (!btn) return;
      activeTag = btn.dataset.tag || '';
      setActiveButton(activeTag);
      applyFilters();
    });

    sortSelect.addEventListener('change', () => {
      applySort();
      applyFilters();
    });
  </script>
</BaseLayout>
