---
import BaseLayout from '../layouts/BaseLayout.astro';
import { execFileSync } from 'node:child_process';
// noindex: utility page
import fs from 'node:fs';

const buildTimestamp = new Date();
const buildDate = buildTimestamp.toISOString().split('T')[0];
const buildTime = buildTimestamp.toISOString().split('T')[1].split('.')[0] + ' UTC';

// Git info (no shell, safe from injection)
let gitSha = '';
let gitShortSha = '';
let gitBranch = '';
try {
  gitSha = execFileSync('git', ['rev-parse', 'HEAD'], { encoding: 'utf-8' }).trim();
  gitShortSha = gitSha.slice(0, 7);
  gitBranch = execFileSync('git', ['rev-parse', '--abbrev-ref', 'HEAD'], { encoding: 'utf-8' }).trim();
} catch { /* not in git */ }

// Package versions
let astroVersion = '5.x';
const nodeVersion = process.version;
interface PkgDep { name: string; version: string }
let deps: PkgDep[] = [];
try {
  const pkg = JSON.parse(fs.readFileSync('package.json', 'utf-8'));
  astroVersion = pkg.dependencies?.astro?.replace('^', '') || '5.x';
  const allDeps = { ...pkg.dependencies, ...pkg.devDependencies };
  deps = Object.entries(allDeps)
    .map(([name, version]) => ({ name, version: (version as string).replace(/^\^|~/, '') }))
    .sort((a, b) => a.name.localeCompare(b.name));
} catch { /* fallback */ }

// Count generated pages (from last build if available)
let pageCount = 0;
try {
  const countFiles = (dir: string): number => {
    let count = 0;
    for (const entry of fs.readdirSync(dir, { withFileTypes: true })) {
      if (entry.isDirectory()) count += countFiles(`${dir}/${entry.name}`);
      else if (entry.name.endsWith('.html')) count++;
    }
    return count;
  };
  pageCount = countFiles('dist');
} catch { /* no dist yet */ }

// Content counts
const contentDir = 'src/content';
let blogCount = 0;
let projectCount = 0;
let galleryCount = 0;
let audioCount = 0;
try {
  blogCount = fs.readdirSync(`${contentDir}/blog`).filter((f: string) => f.endsWith('.md')).length;
  projectCount = fs.readdirSync(`${contentDir}/projects`).filter((f: string) => f.endsWith('.md')).length;
  galleryCount = fs.readdirSync(`${contentDir}/gallery`).filter((f: string) => f.endsWith('.md')).length;
  audioCount = fs.readdirSync(`${contentDir}/audio`).filter((f: string) => f.endsWith('.md')).length;
} catch { /* fallback */ }
---

<BaseLayout title="Colophon" description="How this site is built, what powers it, and who helped." noindex>
  <article class="mx-auto max-w-3xl px-4 py-16 sm:px-6 lg:px-8">
    <header class="mb-12">
      <h1 class="text-text">Colophon</h1>
      <p class="mt-4 text-lg text-text-muted">How this site is built, who helped, and what powers it.</p>
    </header>

    <div class="space-y-8 leading-relaxed text-text">
      <section>
        <h2 class="mb-4 text-xl font-semibold text-text">Technical Stack</h2>
        <dl class="space-y-3">
          <div>
            <dt class="font-medium text-accent">Framework</dt>
            <dd class="text-text-muted">Astro {astroVersion} with TypeScript strict mode</dd>
          </div>
          <div>
            <dt class="font-medium text-accent">Styling</dt>
            <dd class="text-text-muted">Tailwind CSS 3 with CSS custom properties for theming</dd>
          </div>
          <div>
            <dt class="font-medium text-accent">Interactive Components</dt>
            <dd class="text-text-muted">Preact islands (AudioPlayer, MindMap, Quiz, Flashcards, DataTable)</dd>
          </div>
          <div>
            <dt class="font-medium text-accent">Content</dt>
            <dd class="text-text-muted">Markdown + MDX with Astro Content Collections (Zod schemas)</dd>
          </div>
          <div>
            <dt class="font-medium text-accent">Hosting</dt>
            <dd class="text-text-muted">GitHub Pages via GitHub Actions</dd>
          </div>
          <div>
            <dt class="font-medium text-accent">Analytics</dt>
            <dd class="text-text-muted">
              GA4 consent-gated, with build-time data fetch for <a
                href="/analytics/"
                class="text-accent hover:underline">public dashboard</a>
            </dd>
          </div>
          <div>
            <dt class="font-medium text-accent">Search</dt>
            <dd class="text-text-muted">Pagefind — static search index built at deploy time</dd>
          </div>
          <div>
            <dt class="font-medium text-accent">Rich Media</dt>
            <dd class="text-text-muted">NotebookLM Studio (audio overviews, reports, quizzes, mind maps)</dd>
          </div>
        </dl>
      </section>

      <section>
        <h2 class="mb-4 text-xl font-semibold text-text">Design Philosophy</h2>
        <ul class="list-inside list-disc space-y-2 text-text-muted">
          <li>Dark-first with botanical earth-tone palette, dusty copper accent</li>
          <li>System font stack — zero font downloads</li>
          <li>Minimal JavaScript — interactive islands only where needed</li>
          <li>No tracking before consent</li>
          <li>Semantic HTML + progressive enhancement</li>
          <li>Content-first — code serves the writing</li>
        </ul>
      </section>

      <section>
        <h2 class="mb-4 text-xl font-semibold text-text">Build Information</h2>
        <dl class="space-y-3">
          <div>
            <dt class="font-medium text-accent">Last Built</dt>
            <dd class="text-text-muted">{buildDate} at {buildTime}</dd>
          </div>
          {gitShortSha && (
            <div>
              <dt class="font-medium text-accent">Commit</dt>
              <dd class="text-text-muted">
                <a
                  href={`https://github.com/adrianwedd/adrianwedd.com/commit/${gitSha}`}
                  target="_blank"
                  rel="noopener"
                  class="font-mono text-accent hover:underline"
                >
                  {gitShortSha}
                </a>
                {gitBranch && <span> on {gitBranch}</span>}
              </dd>
            </div>
          )}
          <div>
            <dt class="font-medium text-accent">Runtime</dt>
            <dd class="text-text-muted">Astro {astroVersion} / Node {nodeVersion}</dd>
          </div>
          <div>
            <dt class="font-medium text-accent">Content</dt>
            <dd class="text-text-muted">
              {blogCount} posts, {projectCount} projects, {galleryCount} galleries, {audioCount} episodes
            </dd>
          </div>
          {pageCount > 0 && (
            <div>
              <dt class="font-medium text-accent">Pages Generated</dt>
              <dd class="text-text-muted">{pageCount} static HTML pages</dd>
            </div>
          )}
          <div>
            <dt class="font-medium text-accent">Build Process</dt>
            <dd class="text-text-muted">Static site generation (SSG) with CI/CD via GitHub Actions</dd>
          </div>
          <div>
            <dt class="font-medium text-accent">Source Code</dt>
            <dd class="text-text-muted">
              <a
                href="https://github.com/adrianwedd/adrianwedd.com"
                target="_blank"
                rel="noopener"
                class="text-accent hover:underline"
              >
                github.com/adrianwedd/adrianwedd.com
              </a>
            </dd>
          </div>
        </dl>
      </section>

      {deps.length > 0 && (
        <section>
          <h2 class="mb-4 text-xl font-semibold text-text">Dependencies</h2>
          <p class="mb-3 text-sm text-text-muted">{deps.length} packages power this site.</p>
          <div class="grid grid-cols-2 gap-x-6 gap-y-1 text-xs sm:grid-cols-3">
            {deps.map((d) => (
              <div class="flex justify-between gap-2">
                <span class="truncate text-text-muted">{d.name}</span>
                <span class="shrink-0 font-mono text-accent">{d.version}</span>
              </div>
            ))}
          </div>
        </section>
      )}

      <section>
        <h2 class="mb-4 text-xl font-semibold text-text">Credits</h2>
        <div class="space-y-4 text-text-muted">
          <p>
            Built by <a href="https://adrianwedd.com" class="text-accent hover:underline">Adrian Wedd</a> with assistance
            from <a href="https://claude.ai/code" target="_blank" rel="noopener" class="text-accent hover:underline"
              >Claude Code</a
            > (Opus 4.6).
          </p>
          <p>
            NotebookLM automation toolkit: <a
              href="https://github.com/adrianwedd/notebooklm"
              target="_blank"
              rel="noopener"
              class="text-accent hover:underline">github.com/adrianwedd/notebooklm</a
            >
          </p>
          <p>
            Production NotebookLM research pipeline: <a
              href="https://github.com/adrianwedd/failure-first-embodied-ai"
              target="_blank"
              rel="noopener"
              class="text-accent hover:underline">github.com/adrianwedd/failure-first-embodied-ai</a
            >
          </p>
        </div>
      </section>

      <section>
        <h2 class="mb-4 text-xl font-semibold text-text">Typography</h2>
        <p class="text-text-muted">System font stack. No font downloads, native rendering.</p>
        <pre
          class="mt-3 overflow-x-auto rounded border border-border bg-surface-alt p-4 text-xs text-text">system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif</pre>
      </section>

      <section>
        <h2 class="mb-4 text-xl font-semibold text-text">Performance Budget</h2>
        <ul class="list-inside list-disc space-y-2 text-text-muted">
          <li>Zero custom fonts</li>
          <li>Analytics: ~30KB gzipped (consent-gated)</li>
          <li>
            Interactive islands: lazy hydration via <code class="rounded bg-surface-alt px-1 py-0.5 text-text-accent"
              >client:idle</code>
          </li>
          <li>
            Images: lazy loading with native <code class="rounded bg-surface-alt px-1 py-0.5 text-text-accent"
              >loading="lazy"</code>
          </li>
        </ul>
      </section>

      <section>
        <h2 class="mb-4 text-xl font-semibold text-text">License</h2>
        <p class="text-text-muted">
          Content (blog posts, project descriptions, writing) is © {new Date().getFullYear()} Adrian Wedd unless otherwise
          noted. Code is available under MIT license.
        </p>
      </section>

      <section class="border-t border-border pt-8">
        <p class="text-sm text-text-muted">
          Questions about this site's architecture or content pipeline? See <a
            href="https://github.com/adrianwedd/adrianwedd.com/blob/main/docs/NOTEBOOKLM_PIPELINE.md"
            target="_blank"
            rel="noopener"
            class="text-accent hover:underline">NotebookLM Pipeline docs</a
          > or <a
            href="https://github.com/adrianwedd/adrianwedd.com/issues"
            target="_blank"
            rel="noopener"
            class="text-accent hover:underline">open an issue</a
          >.
        </p>
      </section>
    </div>

    <nav class="mt-16 border-t border-border pt-8" aria-label="Back to home">
      <a href="/" class="text-sm text-text-muted transition-colors hover:text-accent"> &larr; Home </a>
    </nav>
  </article>
</BaseLayout>
