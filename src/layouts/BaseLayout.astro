---
import SEOHead from '../components/SEOHead.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import ConsentBanner from '../components/ConsentBanner.astro';
import Analytics from '../components/Analytics.astro';
import '../styles/global.css';

interface Props {
  title: string;
  description: string;
  image?: string;
  type?: 'website' | 'article';
  publishedDate?: string;
  tags?: string[];
}

const props = Astro.props;
---

<!doctype html>
<html lang="en">
  <head>
    <SEOHead {...props} />
    <link rel="alternate" type="application/rss+xml" title="Adrian Wedd — Blog" href="/blog/rss.xml" />
    <link rel="alternate" type="application/rss+xml" title="Adrian Wedd — Audio" href="/audio/feed.xml" />
    {/* Prevent flash of wrong theme */}
    <script is:inline>
      (function () {
        var t = localStorage.getItem('theme');
        if (t === 'light' || (!t && window.matchMedia('(prefers-color-scheme: light)').matches)) {
          document.documentElement.classList.add('light');
        }
      })();
    </script>
  </head>
  <body class="flex min-h-screen flex-col">
    <a
      href="#main-content"
      class="sr-only focus:not-sr-only focus:fixed focus:left-2 focus:top-2 focus:z-[100] focus:rounded-lg focus:bg-accent focus:px-4 focus:py-2 focus:text-sm focus:font-medium focus:text-surface"
    >
      Skip to main content
    </a>
    <Header />
    <main id="main-content" class="flex-1">
      <slot />
    </main>
    <Footer />
    <ConsentBanner />
    <Analytics />

    {/* Keyboard shortcuts overlay */}
    <div id="kb-overlay" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60" role="dialog" aria-label="Keyboard shortcuts">
      <div class="mx-4 max-w-sm rounded-lg border border-border bg-surface p-6 shadow-raised">
        <div class="mb-4 flex items-center justify-between">
          <h2 class="text-lg font-semibold text-text">Keyboard shortcuts</h2>
          <button id="kb-close" class="text-text-muted hover:text-text" aria-label="Close">&times;</button>
        </div>
        <div class="space-y-2 text-sm">
          <p class="text-text-muted font-medium mb-1">Navigation</p>
          <div class="grid grid-cols-[auto_1fr] gap-x-4 gap-y-1">
            <kbd class="font-mono text-xs text-accent">g h</kbd><span class="text-text">Home</span>
            <kbd class="font-mono text-xs text-accent">g b</kbd><span class="text-text">Blog</span>
            <kbd class="font-mono text-xs text-accent">g p</kbd><span class="text-text">Projects</span>
            <kbd class="font-mono text-xs text-accent">g g</kbd><span class="text-text">Gallery</span>
            <kbd class="font-mono text-xs text-accent">g n</kbd><span class="text-text">Now</span>
            <kbd class="font-mono text-xs text-accent">g a</kbd><span class="text-text">About</span>
          </div>
          <p class="text-text-muted font-medium mt-3 mb-1">Actions</p>
          <div class="grid grid-cols-[auto_1fr] gap-x-4 gap-y-1">
            <kbd class="font-mono text-xs text-accent">/</kbd><span class="text-text">Search</span>
            <kbd class="font-mono text-xs text-accent">t</kbd><span class="text-text">Toggle theme</span>
            <kbd class="font-mono text-xs text-accent">?</kbd><span class="text-text">This help</span>
          </div>
        </div>
      </div>
    </div>

    <script is:inline>
      (function () {
        var pending = '';
        var timer;
        var overlay = document.getElementById('kb-overlay');
        var closeBtn = document.getElementById('kb-close');

        function isTyping(e) {
          var t = e.target;
          return t.tagName === 'INPUT' || t.tagName === 'TEXTAREA' || t.tagName === 'SELECT' || t.isContentEditable;
        }

        function showHelp() {
          overlay.classList.remove('hidden');
          overlay.classList.add('flex');
        }

        function hideHelp() {
          overlay.classList.add('hidden');
          overlay.classList.remove('flex');
        }

        var routes = { h: '/', b: '/blog/', p: '/projects/', g: '/gallery/', n: '/now/', a: '/about/' };

        document.addEventListener('keydown', function (e) {
          if (isTyping(e) || e.ctrlKey || e.metaKey || e.altKey) return;

          var key = e.key;

          // Close overlay on Escape
          if (key === 'Escape') { hideHelp(); pending = ''; return; }

          // Show help
          if (key === '?') { e.preventDefault(); showHelp(); return; }

          // Toggle theme
          if (key === 't' && !pending) {
            e.preventDefault();
            document.documentElement.classList.toggle('light');
            localStorage.setItem('theme', document.documentElement.classList.contains('light') ? 'light' : 'dark');
            return;
          }

          // Focus search
          if (key === '/' && !pending) {
            e.preventDefault();
            var searchInput = document.querySelector('[data-pagefind-ui] input, input[type="search"]');
            if (searchInput) { searchInput.focus(); }
            else { window.location.href = '/search/'; }
            return;
          }

          // g + key navigation
          if (key === 'g' && !pending) {
            pending = 'g';
            clearTimeout(timer);
            timer = setTimeout(function () { pending = ''; }, 1000);
            return;
          }

          if (pending === 'g' && routes[key]) {
            e.preventDefault();
            pending = '';
            clearTimeout(timer);
            window.location.href = routes[key];
            return;
          }

          pending = '';
        });

        closeBtn.addEventListener('click', hideHelp);
        overlay.addEventListener('click', function (e) { if (e.target === overlay) hideHelp(); });
      })();
    </script>
  </body>
</html>
